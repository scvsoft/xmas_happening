<!doctype html>
<html>
<head>
    <title>crimildjs</title>
    <script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
    <script data-main="lib/crimild" src="lib/require.js"></script>
    <link rel="stylesheet" type="text/css" href="css/example.css">
    <script type="text/javascript">
        var balls = [
            { position: [0, 12.5, 0], url:'http://scvsoft.github.com/code_happening_2012/' },
            { position: [2, 4, 0], url:'http://hhsaez.github.com/crimildjs/examples/shapes.html' },
            { position: [0, 2, 3], url:'http://hhsaez.github.com/crimildjs/projects/singleton/game.html' },
            { position: [-4, 0, 0] },
            { position: [5, -5, 0] },
            { position: [0, -7, 7] },
            { position: [2, -3, -4] },
            { position: [-7, -9.5, 0] },
            { position: [0, -12, -7] },
            { position: [6, -13, -5] },
        ];

        function initCrimild(canvasId) {
            require(["crimild", "text!../shaders/texture.vert", "text!../shaders/texture.frag"], function(crimild, texture_vs, texture_fs) {
                var canvas = document.getElementById(canvasId);
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                var assetManager = crimild.utils.assetManager();
                assetManager.queueImage("assets/floor_tile.png");
                assetManager.queueImage("assets/blob.png");
                assetManager.loadAll(function() {
                    var ballGroup = crimild.core.groupNode();

                    for (var b in balls) {
                        var ballData = balls[b];

                        ballGroup.attachNode(crimild.core.geometryNode({
                            primitives: [
                                crimild.primitives.spherePrimitive({
                                    type: crimild.core.primitive.types.TRIANGLES,
                                    vertexFormat: crimild.core.vertexFormat({normals: 3}),
                                    radius: 1,
                                })
                            ],
                            local: crimild.math.transformation({
                                translate: ballData.position,
                            })
                        }));
                    };

                    var mainCameraDefaultOrientation = crimild.math.transformation({
                        translate: vec3.create([-10, 10, 45.0]),
                        rotate: quat4.fromAngleAxis(-0.2, [1, 0, 0]),
                    });

                    var mainCamera = crimild.rendering.cameraNode({
                        viewport: [0.0, 0, 1, (canvas.height - 80) / canvas.height],
                        aspectRatio: canvas.width / canvas.height,
                        local: crimild.math.transformation({
                            translate: mainCameraDefaultOrientation.translate,
                            rotate: mainCameraDefaultOrientation.rotate, 
                        }),
                    });

                    var offscreenScene = crimild.core.groupNode({
                        nodes: [
                            crimild.core.groupNode({
                                nodes: [
                                    crimild.core.groupNode({
                                        nodes: [
                                            crimild.core.geometryNode({
                                                primitives: [
                                                    crimild.primitives.spiralPrimitive({
                                                        type: crimild.core.primitive.types.TRIANGLES,
                                                        vertexFormat: crimild.core.vertexFormat({normals: 3}),
                                                        height: 25.0,
                                                        radius: 10.0,
                                                        divisions: vec3.createFrom(200.0, 2.0),
                                                        upperBound: vec3.createFrom(12.0 * Math.PI, 1.0),
                                                    }),
                                                ],
                                            }),
                                            ballGroup,
                                        ],
                                        components: [
                                            crimild.rendering.renderComponent({
                                                effects: [
                                                    crimild.rendering.effect({
                                                        cullState: crimild.rendering.cullState({ enabled: false }),
                                                    })
                                                ]
                                            })
                                        ]
                                    }),
                                    crimild.core.groupNode({
                                        nodes: [
                                            crimild.core.geometryNode({
                                                primitives: [
                                                    crimild.core.primitive({
                                                        type: crimild.core.primitive.types.TRIANGLES,
                                                        vertexBuffer: crimild.core.vertexBufferObject({
                                                            vertexFormat: crimild.core.vertexFormat({
                                                                positions: 3,
                                                                normals: 3,
                                                                textureCoords: 2,
                                                            }),
                                                            vertexCount: 4,
                                                            data: new Float32Array([
                                                                -1000.0, 0.0, -1000.0, 0.0, 1.0, 0.0, 0.0, 0.0,
                                                                -1000.0, 0.0, 1000.0, 0.0, 1.0, 0.0, 0.0, 80.0,
                                                                1000.0, 0.0, 1000.0, 0.0, 1.0, 0.0, 80.0, 80.0,
                                                                1000.0, 0.0, -1000.0, 0.0, 1.0, 0.0, 80.0, 0.0,
                                                            ]),
                                                        }),
                                                        indexBuffer: crimild.core.indexBufferObject({
                                                            indexCount: 6,
                                                            data: new Uint16Array([
                                                                0, 1, 2,
                                                                0, 2, 3,
                                                            ]),
                                                        })
                                                    })
                                                ],
                                                components: [
                                                    crimild.rendering.renderComponent({
                                                        effects: [
                                                            crimild.rendering.effect({
                                                                cullState: crimild.rendering.cullState({ enabled: false }),
                                                                shaderProgram: crimild.rendering.shaderProgram({
                                                                    vertexShader: crimild.rendering.shader({
                                                                        content: texture_vs
                                                                    }),
                                                                    fragmentShader: crimild.rendering.shader({
                                                                        content: texture_fs
                                                                    }),
                                                                }),
                                                                textures: [
                                                                    crimild.rendering.texture({
                                                                        image: assetManager.getImage("assets/floor_tile.png"),
                                                                    })
                                                                ]
                                                            })
                                                        ]
                                                    })
                                                ]
                                            }),
                                            crimild.core.geometryNode({
                                                primitives: [
                                                    crimild.core.primitive({
                                                        type: crimild.core.primitive.types.TRIANGLES,
                                                        vertexBuffer: crimild.core.vertexBufferObject({
                                                            vertexFormat: crimild.core.vertexFormat({
                                                                positions: 3,
                                                                normals: 3,
                                                                textureCoords: 2,
                                                            }),
                                                            vertexCount: 4,
                                                            data: new Float32Array([
                                                                -10.0, 0.0, -10.0, 0.0, 1.0, 0.0, 0.0, 0.0,
                                                                -10.0, 0.0, 10.0, 0.0, 1.0, 0.0, 0.0, 1.0,
                                                                10.0, 0.0, 10.0, 0.0, 1.0, 0.0, 1.0, 1.0,
                                                                10.0, 0.0, -10.0, 0.0, 1.0, 0.0, 1.0, 0.0,
                                                            ]),
                                                        }),
                                                        indexBuffer: crimild.core.indexBufferObject({
                                                            indexCount: 6,
                                                            data: new Uint16Array([
                                                                0, 1, 2,
                                                                0, 2, 3,
                                                            ]),
                                                        })
                                                    })
                                                ],
                                                components: [
                                                    crimild.rendering.renderComponent({
                                                        effects: [
                                                            crimild.rendering.effect({
                                                                cullState: crimild.rendering.cullState({ enabled: false }),
                                                                alphaState: crimild.rendering.alphaState({ enabled: true }),
                                                                shaderProgram: crimild.rendering.shaderProgram({
                                                                    vertexShader: crimild.rendering.shader({
                                                                        content: texture_vs
                                                                    }),
                                                                    fragmentShader: crimild.rendering.shader({
                                                                        content: texture_fs
                                                                    }),
                                                                }),
                                                                textures: [
                                                                    crimild.rendering.texture({
                                                                        image: assetManager.getImage("assets/blob.png"),
                                                                    })
                                                                ]
                                                            })
                                                        ]
                                                    })
                                                ],
                                                local: crimild.math.transformation({
                                                    translate: [0, 1, 0],
                                                }),
                                            }),
                                        ],
                                        local: crimild.math.transformation({
                                            translate: [0, -15, 0],
                                            rotate: quat4.fromAngleAxis(-0.2, [0, 1, 0]),
                                        }),
                                    })
                                ],
                            }),
                            crimild.core.node({
                                components: [
                                    crimild.rendering.lightingComponent({
                                        lights: [
                                            crimild.rendering.light({
                                                color: [0.75, 0.75, 1.0],
                                            })
                                        ]
                                    })
                                ],
                                local: crimild.math.transformation({
                                    translate: [-50.0, 5.0, 50.0]
                                })
                            }),
                            mainCamera,
                        ],
                        local: crimild.math.transformation({
                            translate: [0, 0, 1000]
                        }),
                    });

                    var zoomedIn = false;

                    canvas.onmouseup = function(ev) {
                        var x = event.layerX;
                        var y = event.layerY;
                        var width = canvas.width;
                        var height = canvas.height;

                        var cameraBehavior = function(spec) {
                            spec = spec || {};
                            var cmp = crimild.core.nodeComponent({ name: "behavior" });

                            var _t = 0.0;
                            var _speed = spec.speed || 0.01;

                            cmp.update = function() {
                                if (_t > 1.0) {
                                    cmp.node.local.translate = spec.points[spec.points.length - 1];
                                    cmp.node.perform(crimild.core.worldStateUpdate());

                                    if (spec.callback) {
                                        spec.callback(cmp);
                                    }

                                    cmp.node.detachComponent(cmp);
                                }
                                else {
                                    crimild.math.numeric.computeBezier3D(spec.points, _t, cmp.node.local.translate);
                                    if (spec.orientations) {
                                        quat4.slerp(spec.orientations[0], spec.orientations[1], Math.min(1, _t), cmp.node.local.rotate);
                                    }
                                    cmp.node.perform(crimild.core.worldStateUpdate());

                                    _t += _speed;
                                }

                            };

                            return cmp;
                        };

                        if (zoomedIn) {
                            $('#overlay').fadeOut(1000, function(){
                                zoomedIn = false;
                                mainCamera.attachComponent(cameraBehavior({
                                    points: [
                                        vec3.create(mainCamera.local.translate), 
                                        [mainCamera.local.translate[0], mainCamera.local.translate[1], mainCameraDefaultOrientation.translate[2]],
                                        vec3.create(mainCameraDefaultOrientation.translate)
                                    ],
                                    orientations: [
                                        quat4.fromAngleAxis(0, [0, 1, 0]),
                                        quat4.create(mainCameraDefaultOrientation.rotate)
                                    ],
                                    speed: 0.025,
                                }));
                            });
                        }
                        else {
                            var origin = vec3.create();
                            var direction = vec3.create();
                            var ballPosition = vec3.create();

                            if (mainCamera.get().getPickRay(x, y, width, height, origin, direction)) {
                                var collisionFound = false;

                                for (var b in balls) {
                                    var ball = balls[b];
                                    if (ball.url) {
                                        ballGroup.world.applyToPoint(ball.position, ballPosition);
                                        if (!collisionFound && crimild.math.testIntersectionSphereRay(ballPosition, 1.0, origin, direction)) {
                                            collisionFound = true;

                                            $('#overlay').html("<iframe src='" + ball.url + "'></iframe>");
                                            mainCamera.attachComponent(cameraBehavior({
                                                points: [
                                                    vec3.create(mainCamera.local.translate), 
                                                    [ball.position[0], ball.position[1], mainCameraDefaultOrientation.translate[2]],
                                                    vec3.create(ball.position),
                                                ],
                                                orientations: [
                                                    quat4.create(mainCameraDefaultOrientation.rotate),
                                                    quat4.fromAngleAxis(0, [0, 1, 0]),
                                                ],
                                                speed: 0.005,
                                                callback: function() {
                                                    $('#overlay').fadeIn(1000,function(){

                                                    });             
                                                }
                                            }));

                                            zoomedIn = true;
                                        }
                                    }
                                }
                            }
                        }
                    };

                    crimild.simulation
                        .run({canvas: canvas, scenes: [offscreenScene]})
                        .getRenderer().setClearColor([0, 0, 0, 0]);

                    $('#loading').hide();
                    $('#wrapper').show();
                });
            });
        }
    </script>
    <style type="text/css">
        #overlay {
            margin: auto;
            text-align: center;
            vertical-align: middle;
            font: 2em sans-serif bold;
            color: white;
            background-color: white;
            height: 80%;
            width: 90%;
            z-index: 10000;
            position: absolute;
            top: 100px;
            left: 5%;
            display: none;
        }

        #overlay p {
            position: relative;
            top: 50%;
        }

        #overlay iframe {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body onload="initCrimild('webGLCanvas');" style="background-image: url('assets/xmas.png'); background-repeat: no-repeat; background-color: white;">
    <div id="loading">
        <div class="hud">
            <p>loading, please wait...</p>
        </div>
    </div>

    <div id="wrapper" style="display: none;">
        <div id="overlay">
        </div>
        <canvas id="webGLCanvas">
            Your browser does not support WebGL
        </canvas>
    </div>
</body>
</html>
