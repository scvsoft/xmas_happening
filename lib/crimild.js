/**
 * @license RequireJS text 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

(function(w,D){"object"==typeof exports?module.exports=D(global):"function"==typeof define&&define.amd?define("../lib/glmatrix-1.3.7.min",[],function(){return D(w)}):D(w)})(this,function(w){function D(a){return o=a}function G(){return o="undefined"!=typeof Float32Array?Float32Array:Array}var E={};(function(){if("undefined"!=typeof Float32Array){var a=new Float32Array(1),b=new Int32Array(a.buffer);E.invsqrt=function(c){a[0]=c,b[0]=1597463007-(b[0]>>1);var d=a[0];return d*(1.5-.5*c*d*d)}}else E.invsqrt=function(a){return 1/Math.sqrt(a)}})();var o=null;G();var r={create:function(a){var b=new o(3);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):b[0]=b[1]=b[2]=0,b},createFrom:function(a,b,c){var d=new o(3);return d[0]=a,d[1]=b,d[2]=c,d},set:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b},equal:function(a,b){return a===b||1e-6>Math.abs(a[0]-b[0])&&1e-6>Math.abs(a[1]-b[1])&&1e-6>Math.abs(a[2]-b[2])},add:function(a,b,c){return!c||a===c?(a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a):(c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c)},subtract:function(a,b,c){return!c||a===c?(a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a):(c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c)},multiply:function(a,b,c){return!c||a===c?(a[0]*=b[0],a[1]*=b[1],a[2]*=b[2],a):(c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c)},negate:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b},scale:function(a,b,c){return!c||a===c?(a[0]*=b,a[1]*=b,a[2]*=b,a):(c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c)},normalize:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=Math.sqrt(c*c+d*d+e*e);return g?1===g?(b[0]=c,b[1]=d,b[2]=e,b):(g=1/g,b[0]=c*g,b[1]=d*g,b[2]=e*g,b):(b[0]=0,b[1]=0,b[2]=0,b)},cross:function(a,b,c){c||(c=a);var d=a[0],e=a[1],a=a[2],g=b[0],f=b[1],b=b[2];return c[0]=e*b-a*f,c[1]=a*g-d*b,c[2]=d*f-e*g,c},length:function(a){var b=a[0],c=a[1],a=a[2];return Math.sqrt(b*b+c*c+a*a)},squaredLength:function(a){var b=a[0],c=a[1],a=a[2];return b*b+c*c+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},direction:function(a,b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1],a=a[2]-b[2],b=Math.sqrt(d*d+e*e+a*a);return b?(b=1/b,c[0]=d*b,c[1]=e*b,c[2]=a*b,c):(c[0]=0,c[1]=0,c[2]=0,c)},lerp:function(a,b,c,d){return d||(d=a),d[0]=a[0]+c*(b[0]-a[0]),d[1]=a[1]+c*(b[1]-a[1]),d[2]=a[2]+c*(b[2]-a[2]),d},dist:function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)}},H=null,y=new o(4);r.unproject=function(a,b,c,d,e){e||(e=a),H||(H=x.create());var g=H;return y[0]=2*(a[0]-d[0])/d[2]-1,y[1]=2*(a[1]-d[1])/d[3]-1,y[2]=2*a[2]-1,y[3]=1,x.multiply(c,b,g),x.inverse(g)?(x.multiplyVec4(g,y),0===y[3]?null:(e[0]=y[0]/y[3],e[1]=y[1]/y[3],e[2]=y[2]/y[3],e)):null};var L=r.createFrom(1,0,0),M=r.createFrom(0,1,0),N=r.createFrom(0,0,1),z=r.create();r.rotationTo=function(a,b,c){c||(c=k.create());var d=r.dot(a,b);if(1<=d)k.set(O,c);else if(-0.999999>d)r.cross(L,a,z),1e-6>r.length(z)&&r.cross(M,a,z),1e-6>r.length(z)&&r.cross(N,a,z),r.normalize(z),k.fromAngleAxis(Math.PI,z,c);else{var d=Math.sqrt(2*(1+d)),e=1/d;r.cross(a,b,z),c[0]=z[0]*e,c[1]=z[1]*e,c[2]=z[2]*e,c[3]=.5*d,k.normalize(c)}return 1<c[3]?c[3]=1:-1>c[3]&&(c[3]=-1),c},r.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};var A={create:function(a){var b=new o(9);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8]):b[0]=b[1]=b[2]=b[3]=b[4]=b[5]=b[6]=b[7]=b[8]=0,b},createFrom:function(a,b,c,d,e,g,f,h,j){var i=new o(9);return i[0]=a,i[1]=b,i[2]=c,i[3]=d,i[4]=e,i[5]=g,i[6]=f,i[7]=h,i[8]=j,i},determinant:function(a){var b=a[3],c=a[4],d=a[5],e=a[6],g=a[7],f=a[8];return a[0]*(f*c-d*g)+a[1]*(-f*b+d*e)+a[2]*(g*b-c*e)},inverse:function(a,b){var c=a[0],d=a[1],e=a[2],g=a[3],f=a[4],h=a[5],j=a[6],i=a[7],m=a[8],l=m*f-h*i,C=-m*g+h*j,q=i*g-f*j,n=c*l+d*C+e*q;return n?(n=1/n,b||(b=A.create()),b[0]=l*n,b[1]=(-m*d+e*i)*n,b[2]=(h*d-e*f)*n,b[3]=C*n,b[4]=(m*c-e*j)*n,b[5]=(-h*c+e*g)*n,b[6]=q*n,b[7]=(-i*c+d*j)*n,b[8]=(f*c-d*g)*n,b):null},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],f=a[3],h=a[4],j=a[5],i=a[6],m=a[7],a=a[8],l=b[0],C=b[1],q=b[2],n=b[3],k=b[4],p=b[5],o=b[6],s=b[7],b=b[8];return c[0]=l*d+C*f+q*i,c[1]=l*e+C*h+q*m,c[2]=l*g+C*j+q*a,c[3]=n*d+k*f+p*i,c[4]=n*e+k*h+p*m,c[5]=n*g+k*j+p*a,c[6]=o*d+s*f+b*i,c[7]=o*e+s*h+b*m,c[8]=o*g+s*j+b*a,c},multiplyVec2:function(a,b,c){c||(c=b);var d=b[0],b=b[1];return c[0]=d*a[0]+b*a[3]+a[6],c[1]=d*a[1]+b*a[4]+a[7],c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1],b=b[2];return c[0]=d*a[0]+e*a[3]+b*a[6],c[1]=d*a[1]+e*a[4]+b*a[7],c[2]=d*a[2]+e*a[5]+b*a[8],c},set:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},equal:function(a,b){return a===b||1e-6>Math.abs(a[0]-b[0])&&1e-6>Math.abs(a[1]-b[1])&&1e-6>Math.abs(a[2]-b[2])&&1e-6>Math.abs(a[3]-b[3])&&1e-6>Math.abs(a[4]-b[4])&&1e-6>Math.abs(a[5]-b[5])&&1e-6>Math.abs(a[6]-b[6])&&1e-6>Math.abs(a[7]-b[7])&&1e-6>Math.abs(a[8]-b[8])},identity:function(a){return a||(a=A.create()),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},transpose:function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[5];return a[1]=a[3],a[2]=a[6],a[3]=c,a[5]=a[7],a[6]=d,a[7]=e,a}return b[0]=a[0],b[1]=a[3],b[2]=a[6],b[3]=a[1],b[4]=a[4],b[5]=a[7],b[6]=a[2],b[7]=a[5],b[8]=a[8],b},toMat4:function(a,b){return b||(b=x.create()),b[15]=1,b[14]=0,b[13]=0,b[12]=0,b[11]=0,b[10]=a[8],b[9]=a[7],b[8]=a[6],b[7]=0,b[6]=a[5],b[5]=a[4],b[4]=a[3],b[3]=0,b[2]=a[2],b[1]=a[1],b[0]=a[0],b},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"}},x={create:function(a){var b=new o(16);return a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]),b},createFrom:function(a,b,c,d,e,g,f,h,j,i,m,l,C,q,n,k){var p=new o(16);return p[0]=a,p[1]=b,p[2]=c,p[3]=d,p[4]=e,p[5]=g,p[6]=f,p[7]=h,p[8]=j,p[9]=i,p[10]=m,p[11]=l,p[12]=C,p[13]=q,p[14]=n,p[15]=k,p},set:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},equal:function(a,b){return a===b||1e-6>Math.abs(a[0]-b[0])&&1e-6>Math.abs(a[1]-b[1])&&1e-6>Math.abs(a[2]-b[2])&&1e-6>Math.abs(a[3]-b[3])&&1e-6>Math.abs(a[4]-b[4])&&1e-6>Math.abs(a[5]-b[5])&&1e-6>Math.abs(a[6]-b[6])&&1e-6>Math.abs(a[7]-b[7])&&1e-6>Math.abs(a[8]-b[8])&&1e-6>Math.abs(a[9]-b[9])&&1e-6>Math.abs(a[10]-b[10])&&1e-6>Math.abs(a[11]-b[11])&&1e-6>Math.abs(a[12]-b[12])&&1e-6>Math.abs(a[13]-b[13])&&1e-6>Math.abs(a[14]-b[14])&&1e-6>Math.abs(a[15]-b[15])},identity:function(a){return a||(a=x.create()),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},transpose:function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[3],g=a[6],f=a[7],h=a[11];return a[1]=a[4],a[2]=a[8],a[3]=a[12],a[4]=c,a[6]=a[9],a[7]=a[13],a[8]=d,a[9]=g,a[11]=a[14],a[12]=e,a[13]=f,a[14]=h,a}return b[0]=a[0],b[1]=a[4],b[2]=a[8],b[3]=a[12],b[4]=a[1],b[5]=a[5],b[6]=a[9],b[7]=a[13],b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=a[14],b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinant:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],g=a[4],f=a[5],h=a[6],j=a[7],i=a[8],m=a[9],l=a[10],C=a[11],q=a[12],n=a[13],k=a[14],a=a[15];return q*m*h*e-i*n*h*e-q*f*l*e+g*n*l*e+i*f*k*e-g*m*k*e-q*m*d*j+i*n*d*j+q*c*l*j-b*n*l*j-i*c*k*j+b*m*k*j+q*f*d*C-g*n*d*C-q*c*h*C+b*n*h*C+g*c*k*C-b*f*k*C-i*f*d*a+g*m*d*a+i*c*h*a-b*m*h*a-g*c*l*a+b*f*l*a},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=a[4],h=a[5],j=a[6],i=a[7],m=a[8],l=a[9],k=a[10],q=a[11],n=a[12],o=a[13],p=a[14],r=a[15],s=c*h-d*f,v=c*j-e*f,t=c*i-g*f,u=d*j-e*h,w=d*i-g*h,x=e*i-g*j,y=m*o-l*n,z=m*p-k*n,F=m*r-q*n,A=l*p-k*o,D=l*r-q*o,E=k*r-q*p,B=s*E-v*D+t*A+u*F-w*z+x*y;return B?(B=1/B,b[0]=(h*E-j*D+i*A)*B,b[1]=(-d*E+e*D-g*A)*B,b[2]=(o*x-p*w+r*u)*B,b[3]=(-l*x+k*w-q*u)*B,b[4]=(-f*E+j*F-i*z)*B,b[5]=(c*E-e*F+g*z)*B,b[6]=(-n*x+p*t-r*v)*B,b[7]=(m*x-k*t+q*v)*B,b[8]=(f*D-h*F+i*y)*B,b[9]=(-c*D+d*F-g*y)*B,b[10]=(n*w-o*t+r*s)*B,b[11]=(-m*w+l*t-q*s)*B,b[12]=(-f*A+h*z-j*y)*B,b[13]=(c*A-d*z+e*y)*B,b[14]=(-n*u+o*v-p*s)*B,b[15]=(m*u-l*v+k*s)*B,b):null},toRotationMat:function(a,b){return b||(b=x.create()),b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},toMat3:function(a,b){return b||(b=A.create()),b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[4],b[4]=a[5],b[5]=a[6],b[6]=a[8],b[7]=a[9],b[8]=a[10],b},toInverseMat3:function(a,b){var c=a[0],d=a[1],e=a[2],g=a[4],f=a[5],h=a[6],j=a[8],i=a[9],m=a[10],l=m*f-h*i,k=-m*g+h*j,q=i*g-f*j,n=c*l+d*k+e*q;return n?(n=1/n,b||(b=A.create()),b[0]=l*n,b[1]=(-m*d+e*i)*n,b[2]=(h*d-e*f)*n,b[3]=k*n,b[4]=(m*c-e*j)*n,b[5]=(-h*c+e*g)*n,b[6]=q*n,b[7]=(-i*c+d*j)*n,b[8]=(f*c-d*g)*n,b):null},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],f=a[3],h=a[4],j=a[5],i=a[6],m=a[7],l=a[8],k=a[9],q=a[10],n=a[11],o=a[12],p=a[13],r=a[14],a=a[15],s=b[0],v=b[1],t=b[2],u=b[3];return c[0]=s*d+v*h+t*l+u*o,c[1]=s*e+v*j+t*k+u*p,c[2]=s*g+v*i+t*q+u*r,c[3]=s*f+v*m+t*n+u*a,s=b[4],v=b[5],t=b[6],u=b[7],c[4]=s*d+v*h+t*l+u*o,c[5]=s*e+v*j+t*k+u*p,c[6]=s*g+v*i+t*q+u*r,c[7]=s*f+v*m+t*n+u*a,s=b[8],v=b[9],t=b[10],u=b[11],c[8]=s*d+v*h+t*l+u*o,c[9]=s*e+v*j+t*k+u*p,c[10]=s*g+v*i+t*q+u*r,c[11]=s*f+v*m+t*n+u*a,s=b[12],v=b[13],t=b[14],u=b[15],c[12]=s*d+v*h+t*l+u*o,c[13]=s*e+v*j+t*k+u*p,c[14]=s*g+v*i+t*q+u*r,c[15]=s*f+v*m+t*n+u*a,c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1],b=b[2];return c[0]=a[0]*d+a[4]*e+a[8]*b+a[12],c[1]=a[1]*d+a[5]*e+a[9]*b+a[13],c[2]=a[2]*d+a[6]*e+a[10]*b+a[14],c},multiplyVec4:function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2],b=b[3];return c[0]=a[0]*d+a[4]*e+a[8]*g+a[12]*b,c[1]=a[1]*d+a[5]*e+a[9]*g+a[13]*b,c[2]=a[2]*d+a[6]*e+a[10]*g+a[14]*b,c[3]=a[3]*d+a[7]*e+a[11]*g+a[15]*b,c},translate:function(a,b,c){var d=b[0],e=b[1],b=b[2],g,f,h,j,i,m,l,k,q,n,o,p;return!c||a===c?(a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a):(g=a[0],f=a[1],h=a[2],j=a[3],i=a[4],m=a[5],l=a[6],k=a[7],q=a[8],n=a[9],o=a[10],p=a[11],c[0]=g,c[1]=f,c[2]=h,c[3]=j,c[4]=i,c[5]=m,c[6]=l,c[7]=k,c[8]=q,c[9]=n,c[10]=o,c[11]=p,c[12]=g*d+i*e+q*b+a[12],c[13]=f*d+m*e+n*b+a[13],c[14]=h*d+l*e+o*b+a[14],c[15]=j*d+k*e+p*b+a[15],c)},scale:function(a,b,c){var d=b[0],e=b[1],b=b[2];return!c||a===c?(a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=b,a[9]*=b,a[10]*=b,a[11]*=b,a):(c[0]=a[0]*d,c[1]=a[1]*d,c[2]=a[2]*d,c[3]=a[3]*d,c[4]=a[4]*e,c[5]=a[5]*e,c[6]=a[6]*e,c[7]=a[7]*e,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15],c)},rotate:function(a,b,c,d){var e=c[0],g=c[1],c=c[2],f=Math.sqrt(e*e+g*g+c*c),h,j,i,m,l,k,q,n,o,p,r,s,v,t,u,w,x,y,z,A;return f?(1!==f&&(f=1/f,e*=f,g*=f,c*=f),h=Math.sin(b),j=Math.cos(b),i=1-j,b=a[0],f=a[1],m=a[2],l=a[3],k=a[4],q=a[5],n=a[6],o=a[7],p=a[8],r=a[9],s=a[10],v=a[11],t=e*e*i+j,u=g*e*i+c*h,w=c*e*i-g*h,x=e*g*i-c*h,y=g*g*i+j,z=c*g*i+e*h,A=e*c*i+g*h,e=g*c*i-e*h,g=c*c*i+j,d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a,d[0]=b*t+k*u+p*w,d[1]=f*t+q*u+r*w,d[2]=m*t+n*u+s*w,d[3]=l*t+o*u+v*w,d[4]=b*x+k*y+p*z,d[5]=f*x+q*y+r*z,d[6]=m*x+n*y+s*z,d[7]=l*x+o*y+v*z,d[8]=b*A+k*e+p*g,d[9]=f*A+q*e+r*g,d[10]=m*A+n*e+s*g,d[11]=l*A+o*e+v*g,d):null},rotateX:function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[4],g=a[5],f=a[6],h=a[7],j=a[8],i=a[9],m=a[10],l=a[11];return c?a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[4]=e*b+j*d,c[5]=g*b+i*d,c[6]=f*b+m*d,c[7]=h*b+l*d,c[8]=e*-d+j*b,c[9]=g*-d+i*b,c[10]=f*-d+m*b,c[11]=h*-d+l*b,c},rotateY:function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[0],g=a[1],f=a[2],h=a[3],j=a[8],i=a[9],m=a[10],l=a[11];return c?a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[0]=e*b+j*-d,c[1]=g*b+i*-d,c[2]=f*b+m*-d,c[3]=h*b+l*-d,c[8]=e*d+j*b,c[9]=g*d+i*b,c[10]=f*d+m*b,c[11]=h*d+l*b,c},rotateZ:function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[0],g=a[1],f=a[2],h=a[3],j=a[4],i=a[5],m=a[6],l=a[7];return c?a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[0]=e*b+j*d,c[1]=g*b+i*d,c[2]=f*b+m*d,c[3]=h*b+l*d,c[4]=e*-d+j*b,c[5]=g*-d+i*b,c[6]=f*-d+m*b,c[7]=h*-d+l*b,c},frustum:function(a,b,c,d,e,g,f){f||(f=x.create());var h=b-a,j=d-c,i=g-e;return f[0]=2*e/h,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=2*e/j,f[6]=0,f[7]=0,f[8]=(b+a)/h,f[9]=(d+c)/j,f[10]=-(g+e)/i,f[11]=-1,f[12]=0,f[13]=0,f[14]=-(2*g*e)/i,f[15]=0,f},perspective:function(a,b,c,d,e){return a=c*Math.tan(a*Math.PI/360),b*=a,x.frustum(-b,b,-a,a,c,d,e)},ortho:function(a,b,c,d,e,g,f){f||(f=x.create());var h=b-a,j=d-c,i=g-e;return f[0]=2/h,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=2/j,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=-2/i,f[11]=0,f[12]=-(a+b)/h,f[13]=-(d+c)/j,f[14]=-(g+e)/i,f[15]=1,f},lookAt:function(a,b,c,d){d||(d=x.create());var e,g,f,h,j,i,m,l,k=a[0],o=a[1],a=a[2];return f=c[0],h=c[1],g=c[2],m=b[0],c=b[1],e=b[2],k===m&&o===c&&a===e?x.identity(d):(b=k-m,c=o-c,m=a-e,l=1/Math.sqrt(b*b+c*c+m*m),b*=l,c*=l,m*=l,e=h*m-g*c,g=g*b-f*m,f=f*c-h*b,(l=Math.sqrt(e*e+g*g+f*f))?(l=1/l,e*=l,g*=l,f*=l):f=g=e=0,h=c*f-m*g,j=m*e-b*f,i=b*g-c*e,(l=Math.sqrt(h*h+j*j+i*i))?(l=1/l,h*=l,j*=l,i*=l):i=j=h=0,d[0]=e,d[1]=h,d[2]=b,d[3]=0,d[4]=g,d[5]=j,d[6]=c,d[7]=0,d[8]=f,d[9]=i,d[10]=m,d[11]=0,d[12]=-(e*k+g*o+f*a),d[13]=-(h*k+j*o+i*a),d[14]=-(b*k+c*o+m*a),d[15]=1,d)},fromRotationTranslation:function(a,b,c){c||(c=x.create());var d=a[0],e=a[1],g=a[2],f=a[3],h=d+d,j=e+e,i=g+g,a=d*h,m=d*j,d=d*i,k=e*j,e=e*i,g=g*i,h=f*h,j=f*j,f=f*i;return c[0]=1-(k+g),c[1]=m+f,c[2]=d-j,c[3]=0,c[4]=m-f,c[5]=1-(a+g),c[6]=e+h,c[7]=0,c[8]=d+j,c[9]=e-h,c[10]=1-(a+k),c[11]=0,c[12]=b[0],c[13]=b[1],c[14]=b[2],c[15]=1,c},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"}},k={create:function(a){var b=new o(4);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0,b},createFrom:function(a,b,c,d){var e=new o(4);return e[0]=a,e[1]=b,e[2]=c,e[3]=d,e},set:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},equal:function(a,b){return a===b||1e-6>Math.abs(a[0]-b[0])&&1e-6>Math.abs(a[1]-b[1])&&1e-6>Math.abs(a[2]-b[2])&&1e-6>Math.abs(a[3]-b[3])},identity:function(a){return a||(a=k.create()),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a}},O=k.identity();k.calculateW=function(a,b){var c=a[0],d=a[1],e=a[2];return!b||a===b?(a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a):(b[0]=c,b[1]=d,b[2]=e,b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),b)},k.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},k.inverse=function(a,b){var c=a[0],d=a[1],e=a[2],g=a[3],c=(c=c*c+d*d+e*e+g*g)?1/c:0;return!b||a===b?(a[0]*=-c,a[1]*=-c,a[2]*=-c,a[3]*=c,a):(b[0]=-a[0]*c,b[1]=-a[1]*c,b[2]=-a[2]*c,b[3]=a[3]*c,b)},k.conjugate=function(a,b){return!b||a===b?(a[0]*=-1,a[1]*=-1,a[2]*=-1,a):(b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b)},k.length=function(a){var b=a[0],c=a[1],d=a[2],a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},k.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=Math.sqrt(c*c+d*d+e*e+g*g);return 0===f?(b[0]=0,b[1]=0,b[2]=0,b[3]=0,b):(f=1/f,b[0]=c*f,b[1]=d*f,b[2]=e*f,b[3]=g*f,b)},k.add=function(a,b,c){return!c||a===c?(a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=b[3],a):(c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c)},k.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],a=a[3],f=b[0],h=b[1],j=b[2],b=b[3];return c[0]=d*b+a*f+e*j-g*h,c[1]=e*b+a*h+g*f-d*j,c[2]=g*b+a*j+d*h-e*f,c[3]=a*b-d*f-e*h-g*j,c},k.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2],b=a[0],f=a[1],h=a[2],a=a[3],j=a*d+f*g-h*e,i=a*e+h*d-b*g,k=a*g+b*e-f*d,d=-b*d-f*e-h*g;return c[0]=j*a+d*-b+i*-h-k*-f,c[1]=i*a+d*-f+k*-b-j*-h,c[2]=k*a+d*-h+j*-f-i*-b,c},k.scale=function(a,b,c){return!c||a===c?(a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a):(c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c)},k.toMat3=function(a,b){b||(b=A.create());var c=a[0],d=a[1],e=a[2],g=a[3],f=c+c,h=d+d,j=e+e,i=c*f,k=c*h,c=c*j,l=d*h,d=d*j,e=e*j,f=g*f,h=g*h,g=g*j;return b[0]=1-(l+e),b[1]=k+g,b[2]=c-h,b[3]=k-g,b[4]=1-(i+e),b[5]=d+f,b[6]=c+h,b[7]=d-f,b[8]=1-(i+l),b},k.toMat4=function(a,b){b||(b=x.create());var c=a[0],d=a[1],e=a[2],g=a[3],f=c+c,h=d+d,j=e+e,i=c*f,k=c*h,c=c*j,l=d*h,d=d*j,e=e*j,f=g*f,h=g*h,g=g*j;return b[0]=1-(l+e),b[1]=k+g,b[2]=c-h,b[3]=0,b[4]=k-g,b[5]=1-(i+e),b[6]=d+f,b[7]=0,b[8]=c+h,b[9]=d-f,b[10]=1-(i+l),b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},k.slerp=function(a,b,c,d){d||(d=a);var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3],g,f;return 1<=Math.abs(e)?(d!==a&&(d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=a[3]),d):(g=Math.acos(e),f=Math.sqrt(1-e*e),.001>Math.abs(f)?(d[0]=.5*a[0]+.5*b[0],d[1]=.5*a[1]+.5*b[1],d[2]=.5*a[2]+.5*b[2],d[3]=.5*a[3]+.5*b[3],d):(e=Math.sin((1-c)*g)/f,c=Math.sin(c*g)/f,d[0]=a[0]*e+b[0]*c,d[1]=a[1]*e+b[1]*c,d[2]=a[2]*e+b[2]*c,d[3]=a[3]*e+b[3]*c,d))},k.fromRotationMatrix=function(a,b){b||(b=k.create());var c=a[0]+a[4]+a[8],d;if(0<c)d=Math.sqrt(c+1),b[3]=.5*d,d=.5/d,b[0]=(a[7]-a[5])*d,b[1]=(a[2]-a[6])*d,b[2]=(a[3]-a[1])*d;else{d=k.fromRotationMatrix.s_iNext=k.fromRotationMatrix.s_iNext||[1,2,0],c=0,a[4]>a[0]&&(c=1),a[8]>a[3*c+c]&&(c=2);var e=d[c],g=d[e];d=Math.sqrt(a[3*c+c]-a[3*e+e]-a[3*g+g]+1),b[c]=.5*d,d=.5/d,b[3]=(a[3*g+e]-a[3*e+g])*d,b[e]=(a[3*e+c]+a[3*c+e])*d,b[g]=(a[3*g+c]+a[3*c+g])*d}return b},A.toQuat4=k.fromRotationMatrix,function(){var a=A.create();k.fromAxes=function(b,c,d,e){return a[0]=c[0],a[3]=c[1],a[6]=c[2],a[1]=d[0],a[4]=d[1],a[7]=d[2],a[2]=b[0],a[5]=b[1],a[8]=b[2],k.fromRotationMatrix(a,e)}}(),k.identity=function(a){return a||(a=k.create()),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},k.fromAngleAxis=function(a,b,c){c||(c=k.create());var a=.5*a,d=Math.sin(a);return c[3]=Math.cos(a),c[0]=d*b[0],c[1]=d*b[1],c[2]=d*b[2],c},k.toAngleAxis=function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];return 0<c?(b[3]=2*Math.acos(a[3]),c=E.invsqrt(c),b[0]=a[0]*c,b[1]=a[1]*c,b[2]=a[2]*c):(b[3]=0,b[0]=1,b[1]=0,b[2]=0),b},k.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var J={create:function(a){var b=new o(2);return a?(b[0]=a[0],b[1]=a[1]):(b[0]=0,b[1]=0),b},createFrom:function(a,b){var c=new o(2);return c[0]=a,c[1]=b,c},add:function(a,b,c){return c||(c=b),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c},subtract:function(a,b,c){return c||(c=b),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},multiply:function(a,b,c){return c||(c=b),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c},divide:function(a,b,c){return c||(c=b),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c},scale:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},dist:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},set:function(a,b){return b[0]=a[0],b[1]=a[1],b},equal:function(a,b){return a===b||1e-6>Math.abs(a[0]-b[0])&&1e-6>Math.abs(a[1]-b[1])},negate:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b},normalize:function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1];return 0<c?(c=Math.sqrt(c),b[0]=a[0]/c,b[1]=a[1]/c):b[0]=b[1]=0,b},cross:function(a,b,c){return a=a[0]*b[1]-a[1]*b[0],c?(c[0]=c[1]=0,c[2]=a,c):a},length:function(a){var b=a[0],a=a[1];return Math.sqrt(b*b+a*a)},squaredLength:function(a){var b=a[0],a=a[1];return b*b+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]},direction:function(a,b,c){c||(c=a);var d=a[0]-b[0],a=a[1]-b[1],b=d*d+a*a;return b?(b=1/Math.sqrt(b),c[0]=d*b,c[1]=a*b,c):(c[0]=0,c[1]=0,c[2]=0,c)},lerp:function(a,b,c,d){return d||(d=a),d[0]=a[0]+c*(b[0]-a[0]),d[1]=a[1]+c*(b[1]-a[1]),d},str:function(a){return"["+a[0]+", "+a[1]+"]"}},I={create:function(a){var b=new o(4);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0,b},createFrom:function(a,b,c,d){var e=new o(4);return e[0]=a,e[1]=b,e[2]=c,e[3]=d,e},set:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},equal:function(a,b){return a===b||1e-6>Math.abs(a[0]-b[0])&&1e-6>Math.abs(a[1]-b[1])&&1e-6>Math.abs(a[2]-b[2])&&1e-6>Math.abs(a[3]-b[3])},identity:function(a){return a||(a=I.create()),a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},transpose:function(a,b){if(!b||a===b){var c=a[1];return a[1]=a[2],a[2]=c,a}return b[0]=a[0],b[1]=a[2],b[2]=a[1],b[3]=a[3],b},determinant:function(a){return a[0]*a[3]-a[2]*a[1]},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=c*g-e*d;return f?(f=1/f,b[0]=g*f,b[1]=-d*f,b[2]=-e*f,b[3]=c*f,b):null},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],a=a[3];return c[0]=d*b[0]+e*b[2],c[1]=d*b[1]+e*b[3],c[2]=g*b[0]+a*b[2],c[3]=g*b[1]+a*b[3],c},rotate:function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],a=a[3],f=Math.sin(b),b=Math.cos(b);return c[0]=d*b+e*f,c[1]=d*-f+e*b,c[2]=g*b+a*f,c[3]=g*-f+a*b,c},multiplyVec2:function(a,b,c){c||(c=b);var d=b[0],b=b[1];return c[0]=d*a[0]+b*a[1],c[1]=d*a[2]+b*a[3],c},scale:function(a,b,c){c||(c=a);var d=a[1],e=a[2],g=a[3],f=b[0],b=b[1];return c[0]=a[0]*f,c[1]=d*b,c[2]=e*f,c[3]=g*b,c},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"}},K={create:function(a){var b=new o(4);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):(b[0]=0,b[1]=0,b[2]=0,b[3]=0),b},createFrom:function(a,b,c,d){var e=new o(4);return e[0]=a,e[1]=b,e[2]=c,e[3]=d,e},add:function(a,b,c){return c||(c=b),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},subtract:function(a,b,c){return c||(c=b),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},multiply:function(a,b,c){return c||(c=b),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},divide:function(a,b,c){return c||(c=b),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},scale:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},set:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},equal:function(a,b){return a===b||1e-6>Math.abs(a[0]-b[0])&&1e-6>Math.abs(a[1]-b[1])&&1e-6>Math.abs(a[2]-b[2])&&1e-6>Math.abs(a[3]-b[3])},negate:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},length:function(a){var b=a[0],c=a[1],d=a[2],a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},squaredLength:function(a){var b=a[0],c=a[1],d=a[2],a=a[3];return b*b+c*c+d*d+a*a},lerp:function(a,b,c,d){return d||(d=a),d[0]=a[0]+c*(b[0]-a[0]),d[1]=a[1]+c*(b[1]-a[1]),d[2]=a[2]+c*(b[2]-a[2]),d[3]=a[3]+c*(b[3]-a[3]),d},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"}};return w&&(w.glMatrixArrayType=o,w.MatrixArray=o,w.setMatrixArrayType=D,w.determineMatrixArrayType=G,w.glMath=E,w.vec2=J,w.vec3=r,w.vec4=K,w.mat2=I,w.mat3=A,w.mat4=x,w.quat4=k),{glMatrixArrayType:o,MatrixArray:o,setMatrixArrayType:D,determineMatrixArrayType:G,glMath:E,vec2:J,vec3:r,vec4:K,mat2:I,mat3:A,mat4:x,quat4:k}}),define("crimild.math",["../lib/glmatrix-1.3.7.min"],function(glMatrix){var tempVec3=vec3.create(),numeric={factorial:function(n){if(n===0||n===1)return 1;var result=1;for(var i=2;i<=n;i++)result*=i;return result},binomialCoefficient:function(n,i){return this.factorial(n)/(this.factorial(i)*this.factorial(n-i))},computeBezier3D:function(points,t,result){result||(result=vec3.create()),vec3.set([0,0,0],result);var vTemp=vec3.create(),n=points.length-1;for(var i=0;i<=n;i++){var a=this.binomialCoefficient(n,i),b=Math.pow(1-t,n-i),c=Math.pow(t,i);vec3.scale(points[i],a*b*c,vTemp),vec3.add(result,vTemp,result)}return result},findRealRoots:function(a,b,c){var discriminant=b*b-4*a*c;if(discriminant<0)return[];var s=-b/2*a;if(discriminant==0)return[s];var sqrtDiscriminant=Math.sqrt(discriminant)/a,t0=s+sqrtDiscriminant,t1=s-sqrtDiscriminant;return[t0,t1]}};mat3.multiplyScalar=function(mat,s,dest){return dest||(dest=mat),dest[0]=mat[0]*s,dest[1]=mat[1]*s,dest[2]=mat[2]*s,dest[3]=mat[3]*s,dest[4]=mat[4]*s,dest[5]=mat[5]*s,dest[6]=mat[6]*s,dest[7]=mat[7]*s,dest[8]=mat[8]*s,dest},mat3.createFromAxisAngle=function(axis,angle,dest){dest||(dest=mat3.create());var cosine=Math.cos(angle),sine=Math.sin(angle),oneMinusCosine=1-cosine,a0=axis[0],a1=axis[1],a2=axis[2];return dest[0]=cosine+oneMinusCosine*a0*a0,dest[1]=oneMinusCosine*a0*a1-sine*a2,dest[2]=oneMinusCosine*a0*a2-sine*a1,dest[3]=oneMinusCosine*a0*a1-sine*a2,dest[4]=cosine+oneMinusCosine*a1*a1,dest[5]=oneMinusCosine*a1*a2-sine*a0,dest[6]=oneMinusCosine*a0*a2-sine*a1,dest[7]=oneMinusCosine*a1*a2-sine*a0,dest[8]=cosine+oneMinusCosine*a2*a2,dest};var testIntersectionSphereRay=function(center,radius,origin,direction){var dx=origin[0]-center[0],dy=origin[1]-center[1],dz=origin[2]-center[2],a=direction[0]*direction[0]+direction[1]*direction[1]+direction[2]*direction[2],b=2*(dx*direction[0]+dy*direction[1]+dz*direction[2]),c=dx*dx+dy*dy+dz*dz-radius*radius,roots=numeric.findRealRoots(a,b,c);if(roots.length>0){var maxRoot=roots.length==1?roots[0]:Math.max(roots[0],roots[1]);return maxRoot>0}return!1},transformation=function(spec){spec=spec||{};var that={},_translate=vec3.create([0,0,0]),_rotate=quat4.fromAngleAxis(0,[0,1,0]),_inverseRotate=quat4.inverse(_rotate),_scale=1,_identity=!0;return Object.defineProperties(that,{translate:{get:function(){return _translate},set:function(value){vec3.set(value,_translate),_identity=!1}},rotate:{get:function(){return _rotate},set:function(value){quat4.set(value,_rotate),_identity=!1}},inverseRotate:{get:function(){return quat4.inverse(that.rotate,_inverseRotate),_inverseRotate},set:function(value){quat.set(value,_inverseRotate)}},scale:{get:function(){return _scale},set:function(value){_scale=value,_identity=!1}}}),spec.translate&&(that.translate=spec.translate),spec.rotate&&(that.rotate=spec.rotate),spec.scale&&(that.scale=spec.scale),that.isIdentity=function(){return _identity},that.makeIdentity=function(){vec3.set([0,0,0],_translate),quat4.identity(_rotate),_scale=1,_identity=!0},that.applyToPoint=function(p,dest){return dest||(dest=vec3.create()),quat4.multiplyVec3(that.rotate,p,dest),vec3.add(dest,that.translate,dest),dest},that.applyInverseToPoint=function(p,dest){return dest||(dest=vec3.create()),vec3.subtract(p,that.translate,dest),quat4.multiplyVec3(that.inverseRotate,dest,dest),dest},that.applyToVector=function(v,dest){return dest||(dest=vec3.create()),quat4.multiplyVec3(that.rotate,v,dest),dest},that.applyInverseToVector=function(v,dest){return dest||(dest=vec3.create()),quat4.multiplyVec3(that.inverseRotate,v,dest),dest},that.applyToUnitVector=function(v,dest){return that.applyToVector(v,dest)},that.applyInverseToUnitVector=function(v,dest){},that.applyToPlane=function(p){},that.applyInverseToPlane=function(p){},that.computeDirection=function(dest){return dest||(dest=vec3.create()),quat4.multiplyVec3(that.rotate,[0,0,-1],dest),dest},that.computeWorldDirection=function(dest){return dest||(dest=vec3.create()),quat4.multiplyVec3(that.inverseRotate,[0,0,-1],dest),dest},that.computeUp=function(dest){return dest||(dest=vec3.create()),quat4.multiplyVec3(that.rotate,[0,1,0],dest),dest},that.computeWorldUp=function(dest){dest||(dest=vec3.create());var invRotate=quat4.create();return quat4.inverse(_rotate,invRotate),quat4.multiplyVec3(invRotate,[0,1,0],dest),dest},that.computeRight=function(dest){return dest||(dest=vec3.create()),quat4.multiplyVec3(that.rotate,[1,0,0],dest),dest},that.computeWorldRight=function(dest){return dest||(dest=vec3.create()),quat4.multiplyVec3(that.inverseRotate,[1,0,0],dest),dest},that.computeFrom=function(a,b){a.isIdentity()?that.set(b):b.isIdentity()?that.set(a):(quat4.multiplyVec3(a.rotate,b.translate,tempVec3),vec3.add(tempVec3,a.translate,_translate),quat4.identity(_rotate),quat4.multiply(a.rotate,b.rotate,_rotate),_scale=a.scale*b.scale,_identity=!1)},that.set=function(tx){vec3.set(tx.translate,_translate),quat4.set(tx.rotate,_rotate),_scale=tx.scale,_identity=tx.isIdentity()},that.lookAt=function(target,upReference){},that.toMat4=function(dest){return dest||(dest=mat4.create()),mat4.identity(dest),_identity||mat4.fromRotationTranslation(_rotate,_translate,dest),dest},that},boundingVolume=function(spec){var that={};return that};return{numeric:numeric,transformation:transformation,boundingVolume:boundingVolume,testIntersectionSphereRay:testIntersectionSphereRay}}),define("crimild.core",["./crimild.math"],function(math){var version="0.1.0",object=function(spec){spec=spec||{};var that={},name=spec.name||"";return that.setName=function(aName){name=aName},that.getName=function(){return name},that},node=function(spec){spec=spec||{};var that=object(spec),parent=spec.parent||null,_local=spec.local||math.transformation(),_world=math.transformation(),_components={};Object.defineProperties(that,{local:{get:function(){return _local},set:function(value){_local=value}},world:{get:function(){return _world},set:function(value){_world=value}}}),that.getParent=function(){return parent},that.setParent=function(parentNode){parent=parentNode},that.perform=function(visitor){visitor.traverse(this)},that.accept=function(visitor){visitor.visitNode(this)},that.attachComponent=function(component){component&&(that.detachComponentWithName(component.getName()),_components[component.getName()]=component,component.node=that,component.onAttach())},that.detachComponent=function(component){that.detachComponentWithName(component.getName())},that.detachComponentWithName=function(name){_components[name]&&(_components[name].onDetach(),_components[name].node=null,_components[name]=null)},that.getComponent=function(componentName){return _components[componentName]},that.updateAllComponents=function(appTime,deltaTime){for(var c in _components){var component=_components[c];component&&component.update(appTime,deltaTime)}},that.removeAllComponents=function(){for(var c in _components){var component=_components[c];component&&(component.onDetach(),component.node=null)}_components={}},that.cleanup=function(){that.removeAllComponents()};if(spec.components)for(var i in spec.components)that.attachComponent(spec.components[i]);return that},groupNode=function(spec){spec=spec||{};var components=spec.components;spec.components=null;var that=node(spec),nodes=[];that.attachNode=function(aNode){nodes.push(aNode),aNode.setParent(that)},that.detachNode=function(aNode){var idx=nodes.indexOf(aNode);idx>=0&&(nodes.splice(idx,1),aNode.setParent(null))},that.getNodeCount=function(){return nodes.length},that.getNodeAt=function(index){return nodes[index]},that.removeAllNodes=function(){for(var n in nodes){var node=nodes[n];node&&(node.cleanup(),node.setParent(null))}nodes=[]},that.accept=function(visitor){visitor.visitGroupNode(this)},that.cleanup=function(){that.removeAllNodes(),that.removeAllComponents()};if(spec.nodes)for(var i=0;i<spec.nodes.length;i++)that.attachNode(spec.nodes[i]);if(components)for(var i in components)that.attachComponent(components[i]);return that},vertexFormat=function(spec){var spec=spec||{},that={},_positions=spec.positions||3,_normals=spec.normals||0,_colors=spec.colors||0,_textureCoords=spec.textureCoords||0,_tangents=spec.tangents||0;return Object.defineProperties(that,{positions:{get:function(){return _positions},set:function(value){_positions=value}},normals:{get:function(){return _normals},set:function(value){_normals=value}},colors:{get:function(){return _colors},set:function(value){_colors=value}},textureCoords:{get:function(){return _textureCoords},set:function(value){_textureCoords=value}},tangents:{get:function(){return _tangents},set:function(value){_tangents=value}}}),that.getPositionsOffset=function(){return 0},that.getNormalsOffset=function(){return that.getPositionsOffset()+that.positions},that.getColorsOffset=function(){return that.getNormalsOffset()+that.normals},that.getTextureCoordsOffset=function(){return that.getColorsOffset()+that.colors},that.getTangentsOffset=function(){return that.getTextureCoordsOffset()+that.textureCoords},that.getVertexSize=function(){return that.positions+that.normals+that.colors+that.textureCoords+that.tangents},that.getVertexSizeInBytes=function(){return 4*that.getVertexSize()},that},vertexBufferObject=function(spec){spec=spec||{};var that={},data=spec.data||[],vertexCount=spec.vertexCount||0,vertexFormat=spec.vertexFormat||null,cacheEnabled=spec.cacheEnabled==0?!1:!0;return that.getVertexFormat=function(){return vertexFormat},that.getVertexCount=function(){return vertexCount},that.getData=function(){return data},that.isCacheEnabled=function(){return cacheEnabled},that},indexBufferObject=function(spec){var that={},data=[],indexCount=0;return spec&&(data=spec.data?spec.data:[],indexCount=spec.indexCount?spec.indexCount:0),that.getIndexCount=function(){return indexCount},that.getData=function(){return data},that},primitive=function(spec){spec=spec||{};var that={},type=spec.type||primitive.types.TRIANGLES,vertexBuffer=spec.vertexBuffer||null,indexBuffer=spec.indexBuffer||null;return that.getVertexBuffer=function(){return vertexBuffer},that.setVertexBuffer=function(vbo){vertexBuffer=vbo},that.getIndexBuffer=function(){return indexBuffer},that.setIndexBuffer=function(ibo){indexBuffer=ibo},that.getType=function(){return type},that.setType=function(aType){type=aType},that};primitive.types={POINTS:1,LINES:2,TRIANGLES:3};var geometryNode=function(spec){var that=node(spec),primitives=[];return spec&&spec.primitives&&(primitives=spec.primitives),that.accept=function(visitor){visitor.visitGeometryNode(this)},that.attachPrimitive=function(aPrimitive){primitives.push(aPrimitive)},that.getPrimitiveCount=function(){return primitives.length},that.getPrimitiveAt=function(index){return primitives[index]},that.removeAllPrimitives=function(){primitives=[]},that.cleanup=function(){that.removeAllComponents(),that.removeAllPrimitives()},that},nodeComponent=function(spec){var that=object(spec),_node=null;return Object.defineProperties(that,{node:{get:function(){return _node},set:function(value){_node=value}}}),that.onAttach=function(){},that.onDetach=function(){},that.update=function(){},that},nodeVisitor=function(spec){var that={};return that.traverse=function(aNode){aNode.accept(this)},that.visitNode=function(aNode){},that.visitGroupNode=function(aGroup){for(var i=0;i<aGroup.getNodeCount();i++)aGroup.getNodeAt(i).accept(this)},that.visitGeometryNode=function(aGeometryNode){},that},worldStateUpdate=function(spec){var that=nodeVisitor(spec);return that.visitNode=function(aNode){aNode.getParent()?aNode.world.computeFrom(aNode.getParent().world,aNode.local):aNode.world.set(aNode.local)},that.visitGroupNode=function(aGroup){that.visitNode(aGroup);for(var i=0;i<aGroup.getNodeCount();i++)aGroup.getNodeAt(i).accept(this)},that.visitGeometryNode=function(aGeometry){that.visitNode(aGeometry)},that},updateScene=function(spec){var that=nodeVisitor(spec),_appTime=spec.appTime,_deltaTime=spec.deltaTime;return that.visitNode=function(aNode){aNode.updateAllComponents(_appTime,_deltaTime)},that.visitGroupNode=function(aGroup){that.visitNode(aGroup);for(var i=0;i<aGroup.getNodeCount();i++)aGroup.getNodeAt(i).accept(this)},that.visitGeometryNode=function(aGeometry){that.visitNode(aGeometry)},that};return{getVersion:function(){return version},getFullVersion:function(){return"CrimildJS v"+this.getVersion()+" July 2012"},object:object,node:node,groupNode:groupNode,vertexFormat:vertexFormat,vertexBufferObject:vertexBufferObject,indexBufferObject:indexBufferObject,primitive:primitive,geometryNode:geometryNode,nodeComponent:nodeComponent,nodeVisitor:nodeVisitor,updateScene:updateScene,worldStateUpdate:worldStateUpdate}}),define("crimild.core.primitives",["crimild.core"],function(core){var parametricPrimitive=function(spec){var that=core.primitive(spec),vertexFormat=core.vertexFormat({positions:3}),upperBound,divisions,slices,textureCount;return spec&&(vertexFormat=spec.vertexFormat?spec.vertexFormat:vertexFormat),that.setInterval=function(interval){upperBound=interval.upperBound,divisions=interval.divisions,slices=vec2.subtract(divisions,vec2.createFrom(1,1)),textureCount=interval.textureCount},that.getVertexCount=function(){return divisions[0]*divisions[1]},that.getLineIndexCount=function(){return 4*slices[0]*slices[1]},that.getTriangleIndexCount=function(){return 6*slices[0]*slices[1]},that.evalute=function(domain,dest){return dest||(dest=vec3.create()),dest[0]=0,dest[1]=0,dest[2]=0,dest},that.invertNormal=function(){return!1},that.useDomainInCoord=function(){return!0},that.computeDomain=function(x,y,dest){return dest||(dest=vec2.create()),dest[0]=x*upperBound[0]/slices[0],dest[1]=y*upperBound[1]/slices[1],dest},that.generateVertexBuffer=function(){var vertices=[],s,t,p=vec3.create(),u=vec3.create(),v=vec3.create(),normal=vec3.create(),tangent=vec3.create(),range=vec3.create(),domain=vec2.create();for(var i=0;i<divisions[1];i++)for(var j=0;j<divisions[0];j++)that.computeDomain(j,i,domain),that.evaluate(domain,range),vertices.push(range[0]),vertices.push(range[1]),vertices.push(range[2]),vertexFormat.normals>0&&(s=j,t=i,j===0&&(s+=.01),j===divisions[0]-1&&(s-=.01),i===0&&(t+=.01),i===divisions[1]-1&&(t-=.01),that.evaluate(that.computeDomain(s,t),p),vec3.subtract(that.evaluate(that.computeDomain(s+.01,t)),p,u),vec3.subtract(that.evaluate(that.computeDomain(s,t+.01)),p,v),vec3.cross(u,v,normal),vec3.normalize(normal),that.invertNormal(domain)&&vec3.negate(normal),vertices.push(normal[0]),vertices.push(normal[1]),vertices.push(normal[2])),vertexFormat.textureCoords>0&&(that.useDomainInCoord()?(vertices.push(textureCount[0]*j/divisions[0]),vertices.push(textureCount[1]*i/divisions[1])):(vertices.push(.5*range[0]),vertices.push(.5*range[1]))),vertexFormat.tangents>0&&(s=j,t=i,that.computeDomain(s,t,domain),that.evaluate(domain,p),that.computeDomain(s+.01,t,domain),that.evaluate(domain,u),vec3.subtract(u,p,tangent),vec3.normalize(tangent),that.invertNormal(domain)&&vec3.negate(tangent),vertices.push(tangent[0]),vertices.push(tangent[1]),vertices.push(tangent[2]));var vbo=core.vertexBufferObject({vertexFormat:vertexFormat,vertexCount:that.getVertexCount(),data:new Float32Array(vertices)});that.setVertexBuffer(vbo)},that.generateLineIndexBuffer=function(){var indices=[],vertex=0;for(var i=0;i<slices[1];i++){for(var j=0;j<slices[0];j++){var next=(j+1)%divisions[0];indices.push(vertex+j),indices.push(vertex+next),indices.push(vertex+j),indices.push(vertex+j+divisions[0])}vertex+=divisions[0]}that.setIndexBuffer(core.indexBufferObject({indexCount:that.getLineIndexCount(),data:new Uint16Array(indices)}))},that.generateTriangleIndexBuffer=function(){var indices=[],vertex=0;for(var i=0;i<slices[1];i++){for(var j=0;j<slices[0];j++){var next=(j+1)%divisions[0];indices.push(vertex+j),indices.push(vertex+next),indices.push(vertex+j+divisions[0]),indices.push(vertex+next),indices.push(vertex+next+divisions[0]),indices.push(vertex+j+divisions[0])}vertex+=divisions[0]}that.setIndexBuffer(core.indexBufferObject({indexCount:that.getTriangleIndexCount(),data:new Uint16Array(indices)}))},that.generate=function(){that.generateVertexBuffer(),that.getType()==core.primitive.types.LINES?that.generateLineIndexBuffer():that.generateTriangleIndexBuffer()},that},conePrimitive=function(spec){var that=parametricPrimitive(spec),height=2,radius=1,divisions=vec2.createFrom(20,20);return that.useDomainInCoord=function(){return!1},that.evaluate=function(domain,dest){dest||(dest=vec3.create());var u=domain[0],v=domain[1];return dest[0]=radius*(1-v)*Math.cos(u),dest[1]=height*(v-.5),dest[2]=radius*(1-v)*-Math.sin(u),dest},that.setInterval({divisions:divisions,upperBound:vec2.createFrom(2*Math.PI,1),textureCount:vec2.createFrom(30,20)}),that.generate(),that},kleinBottlePrimitive=function(spec){var that=parametricPrimitive(spec),scale=1,divisions=vec2.createFrom(20,20);return spec&&(spec.scale&&(scale=spec.scale),spec.divisions&&(divisions=spec.divisions)),that.evaluate=function(domain,dest){dest||(dest=vec3.create());var v=1-domain[0],u=domain[1],x0=3*Math.cos(u)*(1+Math.sin(u))+2*(1-Math.cos(u)/2)*Math.cos(u)*Math.cos(v),y0=8*Math.sin(u)+2*(1-Math.cos(u)/2)*Math.sin(u)*Math.cos(v),x1=3*Math.cos(u)*(1+Math.sin(u))+2*(1-Math.cos(u)/2)*Math.cos(v+Math.PI),y1=8*Math.sin(u);return dest[0]=(u<Math.PI?x0:x1)*scale,dest[1]=(u<Math.PI?-y0:-y1)*scale,dest[2]=-2*(1-Math.cos(u)/2)*Math.sin(v)*scale,dest},that.invertNormal=function(domain){return domain[1]>3*Math.PI/2},that.setInterval({divisions:divisions,upperBound:[2*Math.PI,2*Math.PI],textureCount:[1,2]}),that.generate(),that},treefoilKnotPrimitive=function(spec){var that=parametricPrimitive(spec),scale=1,divisions=vec2.createFrom(60,15);return spec&&(spec.scale&&(scale=spec.scale),spec.divisions&&(divisions=spec.divisions)),that.evaluate=function(domain,dest){dest||(dest=vec3.create());var a=.5,b=.3,c=.5,d=.1,u=(Math.PI*2-domain[0])*2,v=domain[1],r=a+b*Math.cos(1.5*u),x=r*Math.cos(u),y=r*Math.sin(u),z=c*Math.sin(1.5*u),dv=vec3.create();dv[0]=-1.5*b*Math.sin(1.5*u)*Math.cos(u)-(a+b*Math.cos(1.5*u))*Math.sin(u),dv[1]=-1.5*b*Math.sin(1.5*u)*Math.sin(u)+(a+b*Math.cos(1.5*u))*Math.cos(u),dv[2]=1.5*c*Math.cos(1.5*u);var q=vec3.createFrom(dv[0],dv[1],dv[2]);vec3.normalize(q);var qvn=vec3.createFrom(q[1],-q[0],0);vec3.normalize(qvn);var ww=vec3.create();return vec3.cross(q,qvn,ww),dest[0]=scale*(x+d*(qvn[0]*Math.cos(v)+ww[0]*Math.sin(v))),dest[1]=scale*(y+d*(qvn[1]*Math.cos(v)+ww[1]*Math.sin(v))),dest[2]=scale*(z+d*ww[2]*Math.sin(v)),dest},that.setInterval({divisions:divisions,upperBound:vec2.createFrom(2*Math.PI,2*Math.PI)}),that.generate(),that},cylinderPrimitive=function(spec){spec=spec||{};var that=parametricPrimitive(spec),height=spec.height||2,radius=spec.radius||1,divisions=vec2.createFrom(20,20);return that.evaluate=function(domain,dest){dest||(dest=vec3.create());var u=domain[0],v=domain[1];return dest[0]=radius*Math.cos(u),dest[1]=height*(v-.5),dest[2]=radius*-Math.sin(u),dest},that.setInterval({divisions:divisions,upperBound:vec2.createFrom(2*Math.PI,1),textureCount:vec2.createFrom(30,20)}),that.generate(),that},spiralPrimitive=function(spec){spec=spec||{};var that=parametricPrimitive(spec),height=spec.height||1,radius=spec.radius||5,divisions=spec.divisions||vec2.createFrom(20,2),upperBound=spec.upperBound||vec2.createFrom(2*Math.PI,1);return that.evaluate=function(domain,dest){dest||(dest=vec3.create());var u=domain[0],v=domain[1];return dest[0]=radius*(1-u/upperBound[0])*Math.cos(u),dest[1]=height*((v+u)/(upperBound[0]+upperBound[1])-.5),dest[2]=radius*(1-u/upperBound[0])*-Math.sin(u),dest},that.setInterval({divisions:divisions,upperBound:upperBound,textureCount:vec2.createFrom(30,20)}),that.generate(),that},spherePrimitive=function(spec){spec=spec||{};var that=core.primitive(spec),latitudeBands=spec.latitudeBands||30,longitudeBands=spec.longitudeBands||30,textureOffset=spec.textureOffset||[0,0],textureScale=spec.textureScale||[1,1],radius=spec.radius||1,vertexFormat=spec.vertexFormat||core.vertexFormat({positions:3});return that.generate=function(){var vertexPositionData=[];for(var latNumber=0;latNumber<=latitudeBands;latNumber++){var theta=latNumber*Math.PI/latitudeBands,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta);for(var longNumber=0;longNumber<=longitudeBands;longNumber++){var phi=longNumber*2*Math.PI/longitudeBands,sinPhi=Math.sin(phi),cosPhi=Math.cos(phi),x=cosPhi*sinTheta,y=cosTheta,z=sinPhi*sinTheta,u=1-longNumber/longitudeBands,v=1-latNumber/latitudeBands;vertexPositionData.push(radius*x),vertexPositionData.push(radius*y),vertexPositionData.push(radius*z),vertexFormat.normals>0&&(vertexPositionData.push(x),vertexPositionData.push(y),vertexPositionData.push(z)),vertexFormat.textureCoords>0&&(vertexPositionData.push(textureOffset[0]+textureScale[0]*u),vertexPositionData.push(textureOffset[1]+textureScale[1]*v))}}var indexData=[];for(var latNumber=0;latNumber<latitudeBands;latNumber++)for(var longNumber=0;longNumber<longitudeBands;longNumber++){var first=latNumber*(longitudeBands+1)+longNumber,second=first+longitudeBands+1;indexData.push(first),indexData.push(first+1),indexData.push(second),indexData.push(second),indexData.push(first+1),indexData.push(second+1)}that.setVertexBuffer(core.vertexBufferObject({vertexFormat:vertexFormat,count:vertexPositionData.length/vertexFormat.getVertexSize(),data:new Float32Array(vertexPositionData)})),that.setIndexBuffer(core.indexBufferObject({indexCount:indexData.length,data:new Uint16Array(indexData)}))},that.generate(),that},cubePrimitive=function(spec){spec=spec||{};var that=core.primitive(spec),scale=spec.scale||vec3.create([1,1,1]),textureOffset=spec.textureOffset||vec2.create([1,1]),textureScale=spec.textureScale||vec2.create([1,1]);return that.generate=function(){var vertices=[-scale[0],-scale[1],scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*1,scale[0],-scale[1],scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*1,scale[0],scale[1],scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*0,-scale[0],scale[1],scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*0,-scale[0],-scale[1],-scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*1,-scale[0],scale[1],-scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*0,scale[0],scale[1],-scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*0,scale[0],-scale[1],-scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*1,-scale[0],scale[1],-scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*0,-scale[0],scale[1],scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*1,scale[0],scale[1],scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*1,scale[0],scale[1],-scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*0,-scale[0],-scale[1],-scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*0,scale[0],-scale[1],-scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*0,scale[0],-scale[1],scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*1,-scale[0],-scale[1],scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*1,scale[0],-scale[1],-scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*1,scale[0],scale[1],-scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*0,scale[0],scale[1],scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*0,scale[0],-scale[1],scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*1,-scale[0],-scale[1],-scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*1,-scale[0],-scale[1],scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*1,-scale[0],scale[1],scale[2],textureOffset[0]+textureScale[0]*1,textureOffset[1]+textureScale[1]*0,-scale[0],scale[1],-scale[2],textureOffset[0]+textureScale[0]*0,textureOffset[1]+textureScale[1]*0];that.setVertexBuffer(core.vertexBufferObject({vertexFormat:core.vertexFormat({textureCoords:2}),data:new Float32Array(vertices),count:24}));var indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];that.setIndexBuffer(core.indexBufferObject({data:new Uint16Array(indices),indexCount:36}))},that.generate(),that},diamondPrimitive=function(spec){spec=spec||{};var that=core.primitive(spec),scale=spec.scale||vec3.create([1,1,1]),textureOffset=spec.textureOffset||vec2.create([1,1]),textureScale=spec.textureScale||vec2.create([1,1]),vertexFormat=spec.vertexFormat||core.vertexFormat({textureCoords:2});return that.generate=function(){var x=scale[0],y=scale[1],z=scale[2],vertices=[-x,0,0,textureOffset[0],textureOffset[1]+.5*textureScale[1],0,-y,0,textureOffset[0]+.5*textureScale[0],textureOffset[1]+textureScale[1],x,0,0,textureOffset[0]+textureScale[0],textureOffset[1]+.5*textureScale[1],0,y,0,textureOffset[0]+.5*textureScale[0],textureOffset[1],0,0,z,textureOffset[0]+.5*textureScale[0],textureOffset[1]+.5*textureScale[1],0,0,-z,textureOffset[0]+.5*textureScale[0],textureOffset[1]+.5*textureScale[1]];that.setVertexBuffer(core.vertexBufferObject({vertexFormat:vertexFormat,data:new Float32Array(vertices),count:6}));var indices=[0,1,4,4,1,2,3,4,2,3,0,4,3,2,5,2,1,5,5,1,0,3,5,0];that.setIndexBuffer(core.indexBufferObject({data:new Uint16Array(indices),indexCount:24}))},that.generate(),that};return{parametricPrimitive:parametricPrimitive,conePrimitive:conePrimitive,kleinBottlePrimitive:kleinBottlePrimitive,treefoilKnotPrimitive:treefoilKnotPrimitive,cylinderPrimitive:cylinderPrimitive,spiralPrimitive:spiralPrimitive,spherePrimitive:spherePrimitive,cubePrimitive:cubePrimitive,diamondPrimitive:diamondPrimitive}}),define("text",["module"],function(module){var progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],xmlRegExp=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,bodyRegExp=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,hasLocation=typeof location!="undefined"&&location.href,defaultProtocol=hasLocation&&location.protocol&&location.protocol.replace(/\:/,""),defaultHostName=hasLocation&&location.hostname,defaultPort=hasLocation&&(location.port||undefined),buildMap=[],masterConfig=module.config&&module.config()||{},text,fs;return text={version:"2.0.1",strip:function(content){if(content){content=content.replace(xmlRegExp,"");var matches=content.match(bodyRegExp);matches&&(content=matches[1])}else content="";return content},jsEscape:function(content){return content.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:masterConfig.createXhr||function(){var xhr,i,progId;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(i=0;i<3;i+=1){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}return xhr},parseName:function(name){var strip=!1,index=name.indexOf("."),modName=name.substring(0,index),ext=name.substring(index+1,name.length);return index=ext.indexOf("!"),index!==-1&&(strip=ext.substring(index+1,ext.length),strip=strip==="strip",ext=ext.substring(0,index)),{moduleName:modName,ext:ext,strip:strip}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(url,protocol,hostname,port){var match=text.xdRegExp.exec(url),uProtocol,uHostName,uPort;return match?(uProtocol=match[2],uHostName=match[3],uHostName=uHostName.split(":"),uPort=uHostName[1],uHostName=uHostName[0],(!uProtocol||uProtocol===protocol)&&(!uHostName||uHostName.toLowerCase()===hostname.toLowerCase())&&(!uPort&&!uHostName||uPort===port)):!0},finishLoad:function(name,strip,content,onLoad){content=strip?text.strip(content):content,masterConfig.isBuild&&(buildMap[name]=content),onLoad(content)},load:function(name,req,onLoad,config){if(config.isBuild&&!config.inlineText){onLoad();return}masterConfig.isBuild=config.isBuild;var parsed=text.parseName(name),nonStripName=parsed.moduleName+"."+parsed.ext,url=req.toUrl(nonStripName),useXhr=masterConfig.useXhr||text.useXhr;!hasLocation||useXhr(url,defaultProtocol,defaultHostName,defaultPort)?text.get(url,function(content){text.finishLoad(name,parsed.strip,content,onLoad)},function(err){onLoad.error&&onLoad.error(err)}):req([nonStripName],function(content){text.finishLoad(parsed.moduleName+"."+parsed.ext,parsed.strip,content,onLoad)})},write:function(pluginName,moduleName,write,config){if(buildMap.hasOwnProperty(moduleName)){var content=text.jsEscape(buildMap[moduleName]);write.asModule(pluginName+"!"+moduleName,"define(function () { return '"+content+"';});\n")}},writeFile:function(pluginName,moduleName,req,write,config){var parsed=text.parseName(moduleName),nonStripName=parsed.moduleName+"."+parsed.ext,fileName=req.toUrl(parsed.moduleName+"."+parsed.ext)+".js";text.load(nonStripName,req,function(value){var textWrite=function(contents){return write(fileName,contents)};textWrite.asModule=function(moduleName,contents){return write.asModule(moduleName,fileName,contents)},text.write(pluginName,nonStripName,textWrite,config)},config)}},typeof process!="undefined"&&process.versions&&!!process.versions.node?(fs=require.nodeRequire("fs"),text.get=function(url,callback){var file=fs.readFileSync(url,"utf8");file.indexOf("")===0&&(file=file.substring(1)),callback(file)}):text.createXhr()?text.get=function(url,callback,errback){var xhr=text.createXhr();xhr.open("GET",url,!0),masterConfig.onXhr&&masterConfig.onXhr(xhr,url),xhr.onreadystatechange=function(evt){var status,err;xhr.readyState===4&&(status=xhr.status,status>399&&status<600?(err=new Error(url+" HTTP status: "+status),err.xhr=xhr,errback(err)):callback(xhr.responseText))},xhr.send(null)}:typeof Packages!="undefined"&&(text.get=function(url,callback){var encoding="utf-8",file=new java.io.File(url),lineSeparator=java.lang.System.getProperty("line.separator"),input=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file),encoding)),stringBuffer,line,content="";try{stringBuffer=new java.lang.StringBuffer,line=input.readLine(),line&&line.length()&&line.charAt(0)===65279&&(line=line.substring(1)),stringBuffer.append(line);while((line=input.readLine())!==null)stringBuffer.append(lineSeparator),stringBuffer.append(line);content=String(stringBuffer.toString())}finally{input.close()}callback(content)}),text}),define("text!../shaders/simple.vert",[],function(){return"/**\n    Implements a generic vertex shaders\n\n    Disclaimer: This program is not intended to be used in productive environments\n*/\n\nattribute vec3 aVertexPosition;\nattribute vec3 aVertexNormal;\nattribute vec2 aTextureCoord;\n\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform mat3 uNMatrix;\n\nuniform bool uUseLighting;\n\nvarying vec4 vDestinationColor;\nvarying vec2 vTextureCoord;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vViewVector;\n\nvoid main(void) {\n	vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);\n    vViewVector = normalize(-vPosition.xyz);\n    vTextureCoord = aTextureCoord;\n    vNormal = uNMatrix * aVertexNormal;\n\n    gl_Position = uPMatrix * vPosition;\n\n    if (!uUseLighting) {\n    	vDestinationColor = vec4(aVertexPosition, 1.0);\n    }\n}\n"}),define("text!../shaders/simple.frag",[],function(){return"/**\n    Implements a fragment shaders\n\n    Disclaimer: This program is not intended to be used in productive environments\n*/\n\nprecision highp float;\n\nstruct LightSource {\n    vec3 Position;\n    vec3 Attenuation;\n    vec3 Direction;\n    vec3 Color;\n    float OuterCutoff;\n    float InnerCutoff;\n    float Exponent;\n};\n\nstruct Material {\n    vec3 Ambient;\n    vec3 Diffuse;\n    vec3 Specular;\n    float Shininess;\n};\n\nuniform bool uUseLighting;\nuniform bool uUsePerPixelShading;\nuniform int uLightCount;\nuniform LightSource uLights[4];\nuniform Material uMaterial;\n\nvarying vec4 vDestinationColor;\nvarying vec2 vTextureCoord;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vViewVector;\n\nvoid main(void) {\n    vec4 result = vec4(1.0, 1.0, 1.0, 1.0);\n\n    if (uUseLighting) {\n        result = vec4(uMaterial.Ambient, 1.0);\n\n        for (int i = 0; i < 4; i++) {\n            if (i >= uLightCount) {\n                break;\n            }\n\n            // compute light to vertex vector\n            vec3 L = normalize(uLights[i].Position - vPosition.xyz);\n\n            // compute diffuse factor\n            float df = dot(vNormal, L);\n            if (df > 0.0) {\n                // compute specular factor\n                vec3 r = -normalize(reflect(L, vNormal));\n                float sf = pow(max(dot(r, vViewVector), 0.0), uMaterial.Shininess);\n\n                // add to color\n                result.xyz += (df * uMaterial.Diffuse + sf * uMaterial.Specular) * uLights[i].Color;\n            }\n        }\n    }\n    else {\n        result = vDestinationColor;\n    }\n\n    gl_FragColor = result;\n}\n\n"}),define("text!../shaders/ubbershader.vert",[],function(){return"/**\n    Implements a generic vertex shaders\n\n    Disclaimer: This program is not intended to be used in productive environments\n*/\n\nattribute vec3 aVertexPosition;\nattribute vec3 aVertexNormal;\nattribute vec2 aTextureCoord;\n\n//uniform mat4 uMVMatrix;\nuniform mat4 uMMatrix;\nuniform mat4 uVMatrix;\nuniform mat4 uPMatrix;\nuniform mat3 uNMatrix;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vViewVector;\n\nvoid main(void) {\n	vPosition = uMMatrix * vec4(aVertexPosition, 1.0);\n	vec4 vViewVertex = uVMatrix * vPosition;\n    vViewVector = normalize(-vViewVertex.xyz);\n    vTextureCoord = aTextureCoord;\n    vNormal = uNMatrix * aVertexNormal;\n\n    gl_Position = uPMatrix * vViewVertex;\n}\n"}),define("text!../shaders/ubbershader.frag",[],function(){return"/**\n    Implements a fragment shaders\n\n    Disclaimer: This program is not intended to be used in productive environments\n*/\n\nprecision highp float;\n\nstruct LightSource {\n    vec3 Position;\n    vec3 Attenuation;\n    vec3 Direction;\n    vec3 Color;\n    float OuterCutoff;\n    float InnerCutoff;\n    float Exponent;\n};\n\nstruct Material {\n    vec3 Ambient;\n    vec3 Diffuse;\n    vec3 Specular;\n    float Shininess;\n};\n\nuniform bool uUseLighting;\nuniform bool uUsePerPixelShading;\nuniform int uLightCount;\nuniform LightSource uLights[4];\nuniform Material uMaterial;\n\nuniform bool uUseTextures;\nuniform sampler2D uSampler;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vViewVector;\n\nvoid main(void) {\n    vec4 baseColor = vec4(1.0, 1.0, 1.0, 1.0);\n\n    if (uUseTextures) {\n        baseColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n    }\n\n    baseColor *= vec4(uMaterial.Diffuse, 1.0);\n\n    vec4 result = vec4(1.0, 1.0, 1.0, 1.0);\n\n    if (uUseLighting) {\n        result = vec4(uMaterial.Ambient * baseColor.rgb, baseColor.a);\n\n        for (int i = 0; i < 4; i++) {\n            if (i >= uLightCount) {\n                break;\n            }\n\n            // compute light to vertex vector\n            vec3 L = normalize(uLights[i].Position - vPosition.xyz);\n\n            // compute diffuse factor\n            float df = dot(vNormal, L);\n            if (df > 0.0) {\n                // compute specular factor\n                vec3 r = -normalize(reflect(L, vNormal));\n                float sf = pow(max(dot(r, vViewVector), 0.0), uMaterial.Shininess);\n\n                // add to color\n                result.xyz += (df * uMaterial.Diffuse * baseColor.rgb + sf * uMaterial.Specular) * uLights[i].Color;\n            }\n        }\n    }\n    else {\n        result = baseColor;\n    }\n\n    gl_FragColor = result;\n}\n\n"}),define("crimild.rendering",["./crimild.core","./crimild.math","text!../shaders/simple.vert","text!../shaders/simple.frag","text!../shaders/ubbershader.vert","text!../shaders/ubbershader.frag"],function(core,math,simple_vs,simple_fs,ubbershader_vs,ubbershader_fs){var renderState=function(spec){spec=spec||{};var that=core.object(spec),_enabled=spec.enabled||!1;return Object.defineProperties(that,{enabled:{get:function(){return _enabled},set:function(value){_enabled=value}}}),that},alphaState=function(spec){spec=spec||{};var that=renderState({name:"alpha",enabled:spec.enabled==1?!0:!1}),_srcBlendFunc=spec.srcBlendFunc||alphaState.srcBlendFunc.SRC_ALPHA,_dstBlendFunc=spec.dstBlendFunc||alphaState.dstBlendFunc.ONE_MINUS_SRC_ALPHA;return Object.defineProperties(that,{srcBlendFunc:{get:function(){return _srcBlendFunc},set:function(value){_srcBlendFunc=value}},dstBlendFunc:{get:function(){return _dstBlendFunc},set:function(value){_dstBlendFunc=value}}}),that};alphaState.srcBlendFunc={ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773},alphaState.dstBlendFunc={ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773};var depthState=function(spec){spec=spec||{};var that=renderState({name:"depth",enabled:spec.enabled==0?!1:!0});return that},cullState=function(spec){spec=spec||{};var that=renderState({name:"cull",enabled:spec.enabled==0?!1:!0});return that},light=function(spec){spec=spec||{};var that={},_position=vec3.create([0,0,0]),_attenuation=vec3.create([1,0,.01]),_direction=vec3.create([0,0,0]),_color=vec3.create([1,1,1]),_outerCutoff=0,_innerCutoff=0,_exponent=0;return Object.defineProperties(that,{position:{get:function(){return _position},set:function(value){vec3.set(value,_position)}},attenuation:{get:function(){return _attenuation},set:function(value){vec3.set(value,_attenuation)}},direction:{get:function(){return _direction},set:function(value){vec3.set(value,_direction)}},color:{get:function(){return _color},set:function(value){vec3.set(value,_color)}},outerCutoff:{get:function(){return _outerCutoff},set:function(value){_outerCutoff=value}},innerCutoff:{get:function(){return _innerCutoff},set:function(value){_innerCutoff=value}},exponent:{get:function(){return _exponent},set:function(value){_exponent=value}}}),spec.position&&(that.position=spec.position),spec.attenuation&&(that.attenuation=spec.attenuation),spec.direction&&(that.direction=spec.direction),spec.color&&(that.color=spec.color),spec.outerCutoff&&(that.outerCutoff=spec.outerCutoff),spec.innerCutoff&&(that.innerCutoff=spec.innerCutoff),spec.exponent&&(that.exponent=spec.exponent),that},lightingComponent=function(spec){spec=spec||{};var that=core.nodeComponent({name:"lighting"}),lights=spec.lights||[],tempDirection=vec3.create();return that.getLightCount=function(){return lights.length},that.getLightAt=function(index){return lights[index]},that.update=function(){that.node.world.computeDirection(tempDirection);for(var i in lights)lights[i].position=that.node.world.translate,lights[i].direction=tempDirection},that},lightNode=function(spec){spec=spec||{};var that=core.node(spec);return that.attachComponent(lightingComponent(spec)),that},renderComponent=function(spec){spec=spec||{};var that=core.nodeComponent({name:"render"}),effects=spec.effects||[];return that.getEffectCount=function(){return effects.length},that.getEffectAt=function(index){return effects[index]},that},geometryRenderComponent=function(spec){var that=core.nodeComponent({name:"geometryRender"}),effects=[],lights=[],uniforms={};return that.getEffectCount=function(){return effects.length},that.getEffectAt=function(index){return effects[index]},that.getLightCount=function(){return lights.length},that.getLightAt=function(index){return lights[index]},that.eachEffect=function(expresion){for(var i in effects)expresion(effects[i])},that.eachLight=function(expresion){for(var i in lights)expresion(lights[i])},that.getUniform=function(name){return uniforms[name]},that.eachUniform=function(expresion){for(var i in uniforms)expresion(uniforms[i])},that.reset=function(opts){opts=opts||{},effects=[];if(opts.effects)for(var e in opts.effects)effects.push(opts.effects[e]);lights=[];if(opts.lights)for(var l in opts.lights)lights.push(opts.lights[l]);uniforms={};if(opts.uniforms)for(var u in opts.uniforms)uniforms[u]=opts.uniforms[u]},that},image=function(spec){spec=spec||{};var that={},contents=spec.contents||null,ready=spec.contents?!0:!1;return that.isReady=function(){return ready},that.getContents=function(){return contents},that},texture=function(spec){spec=spec||{};var that={},_image,_name=spec.name||"uSampler";return Object.defineProperties(that,{name:{get:function(){return _name}},image:{get:function(){return _image},set:function(value){_image=value}}}),spec.image&&(that.image=spec.image),that},shader=function(spec){var that={},content;if(spec)if(spec.content)content=spec.content;else if(spec.scriptId){var script=document.getElementById(spec.scriptId),str="",k=script.firstChild;while(k)k.nodeType==3&&(str+=k.textContent),k=k.nextSibling;content=str}return that.getContent=function(){return content},that.setContent=function(value){content=value},that},shaderProgram=function(spec){var that={},vertexShader,fragmentShader;return spec&&(vertexShader=spec.vertexShader?spec.vertexShader:vertexShader,fragmentShader=spec.fragmentShader?spec.fragmentShader:fragmentShader),that.getVertexShader=function(){return vertexShader},that.setVertexShader=function(shader){vertexShader=shader},that.getFragmentShader=function(){return fragmentShader},that.setFragmentShader=function(shader){fragmentShader=shader},that},shaderUniform=function(spec){spec=spec||{};var that={},_name=spec.name,_type=spec.type||shaderUniform.type.UNKNOWN,_data=spec.data,_count=spec.count||1;return Object.defineProperties(that,{name:{get:function(){return _name},set:function(value){_name=value}},type:{get:function(){return _type},set:function(value){_type=value}},data:{get:function(){return _data},set:function(value){_data=value}},count:{get:function(){return _count},set:function(value){_count=value}}}),that};shaderUniform.type={UNKNOWN:0,FLOAT:1,INT:2,MATRIX_3:3,MATRIX_4:4,BOOL:5};var shaderUniformComponent=function(spec){spec=spec||{};var that=core.nodeComponent({name:"uniforms"}),_uniforms={};that.addUniform=function(uniform){uniform.name&&(_uniforms[uniform.name]=uniform)},that.getUniform=function(name){return _uniforms[name]},that.each=function(expression){for(var i in _uniforms)expression(_uniforms[i])};if(spec.uniforms)for(var i in spec.uniforms)that.addUniform(spec.uniforms[i]);return that},effect=function(spec){spec=spec||{};var that={},program=spec.shaderProgram||null,textures=spec.textures||[],_ambient=[.2,.2,.2],_diffuse=[.8,.8,.8],_specular=[.8,.8,.8],_shininess=50,_alphaState=spec.alphaState||alphaState(),_depthState=spec.depthState||depthState(),_cullState=spec.cullState||cullState();return Object.defineProperties(that,{ambient:{get:function(){return _ambient},set:function(value){vec3.set(value,_ambient)}},diffuse:{get:function(){return _diffuse},set:function(value){vec3.set(value,_diffuse)}},specular:{get:function(){return _specular},set:function(value){vec3.set(value,_specular)}},shininess:{get:function(){return _shininess},set:function(value){_shininess=value}},alphaState:{get:function(){return _alphaState},set:function(vaue){_alphaState=alphaState}},depthState:{get:function(){return _depthState},set:function(value){_depthState=value}},cullState:{get:function(){return _cullState},set:function(value){_cullState=value}}}),spec.ambient&&(that.ambient=spec.ambient),spec.diffuse&&(that.diffuse=spec.diffuse),spec.specular&&(that.specular=spec.specular),spec.shininess&&(that.shininess=spec.shininess),that.setProgram=function(aProgram){program=aProgram},that.getProgram=function(){return program},that.attachTexture=function(aTexture){textures.push(aTexture)},that.getTextureCount=function(){return textures.length},that.getTextureAt=function(index){return textures[index]},that},fetchLightsAndUniforms=function(spec){spec=spec||{};var that=core.nodeVisitor(spec),_lights=spec.lights||[],_uniforms=spec.uniforms||{},i=0;return Object.defineProperties(that,{lights:{get:function(){return _lights},set:function(value){_lights=value}},uniforms:{get:function(){return _uniforms},set:function(value){_uniforms=value}}}),that.traverse=function(node){node.accept(that)},that.visitNode=function(node){var lc=node.getComponent("lighting");if(lc)for(i=0;i<lc.getLightCount();i++)_lights.push(lc.getLightAt(i));var uc=node.getComponent("uniforms");uc&&uc.each(function(uniform){uniform.name&&(_uniforms[uniform.name]=uniform)})},that.visitGroupNode=function(group){that.visitNode(group);for(var i=0;i<group.getNodeCount();i++)group.getNodeAt(i).accept(this)},that.visitGeometryNode=function(geometry){that.visitNode(geometry)},that},renderStateUpdate=function(spec){var that=core.nodeVisitor(spec),effects=[],lights=[],uniforms={};return that.propagateFromRoot=function(aNode){aNode.getParent()?that.propagateFromRoot(aNode.getParent()):aNode.perform(fetchLightsAndUniforms({lights:lights,uniforms:uniforms}));var grc=aNode.getComponent("render");if(grc)for(var i=0;i<grc.getEffectCount();i++)effects.push(grc.getEffectAt(i))},that.traverse=function(aNode){effects=[],lights=[],aNode.getParent()?that.propagateFromRoot(aNode.getParent()):aNode.perform(fetchLightsAndUniforms({lights:lights,uniforms:uniforms})),aNode.accept(that)},that.visitGroupNode=function(group){var i,tempEffects=effects.slice(),grc=group.getComponent("render");if(grc)for(i=0;i<grc.getEffectCount();i++)effects.push(grc.getEffectAt(i));var uc=group.getComponent("uniforms");uc&&uc.each(function(uniform){uniform.name&&(uniforms[uniform.name]=uniform)});for(i=0;i<group.getNodeCount();i++){var node=group.getNodeAt(i);node.accept(this)}effects=tempEffects},that.visitGeometryNode=function(geometry){var grc=geometry.getComponent("geometryRender");grc||(grc=geometryRenderComponent({}),geometry.attachComponent(grc));var rc=geometry.getComponent("render"),tempEffects=effects.slice();if(rc)for(var i=0;i<rc.getEffectCount();i++)effects.push(rc.getEffectAt(i));var uc=geometry.getComponent("uniforms");uc&&uc.each(function(uniform){uniform.name&&(uniforms[uniform.name]=uniform)}),grc.reset({effects:effects,lights:lights,uniforms:uniforms}),effects=tempEffects},that},framebuffer=function(spec){spec=spec||{};var that={},_texture=spec.texture||texture(spec),_width=spec.width||512,_height=spec.height||512,_name=spec.name,_clearColor=spec.clearColor?vec4.create(spec.clearColor):[0,0,0,1];return Object.defineProperties(that,{name:{get:function(){return _name},set:function(value){_name=value}},texture:{get:function(){return _texture},set:function(value){_texture=value}},width:{get:function(){return _width},set:function(value){_width=width}},height:{get:function(){return _height},set:function(value){_height=value}},clearColor:{get:function(){return _clearColor},set:function(value){_clearColor=value}}}),that},camera=function(spec){spec=spec||{};var that={},_transformation=spec.transformation||math.transformation(),_viewport=spec.viewport||[0,0,1,1],_pMatrix=spec.projection||mat4.create(),_target=spec.target,_renderer=null;return spec.projection||mat4.perspective(spec.fov||45,spec.aspectRatio||4/3,spec.near||.1,spec.far||1e3,_pMatrix),Object.defineProperties(that,{renderer:{get:function(){return _renderer},set:function(value){_renderer=value}},viewport:{get:function(){return _viewport},set:function(value){vec4.set(value,_viewport)}},transformation:{get:function(){return _transformation},set:function(value){_transformation.set(value)}},target:{get:function(){return _target},set:function(value){_target=value}}}),that.computeViewMatrix=function(dest){return dest||(dest=mat4.create()),_transformation.toMat4(dest),mat4.inverse(dest),dest},that.computeProjectMatrix=function(dest){return dest||(dest=mat4.create()),mat4.set(_pMatrix,dest),dest},that.unproject=function(x,y,z,result){var wx=2*(x-_viewport[0])/_viewport[2]-1,wy=2*(y-_viewport[1])/_viewport[3]-1,wz=2*z-1,m=mat4.create();that.computeViewMatrix(m),mat4.multiply(_pMatrix,m,m),mat4.inverse(m,m);var n=[wx,wy,wz,1];return mat4.multiplyVec4(m,n,n),n[3]===0?!1:(result[0]=n[0]/n[3],result[1]=n[1]/n[3],result[2]=n[2]/n[3],!0)},that.getPickRay=function(x,y,width,height,origin,direction){var p0=vec3.create(),p1=vec3.create();return that.unproject(x/width,(height-y)/height,0,p0)?that.unproject(x/width,(height-y)/height,1,p1)?(vec3.subtract(p1,p0,direction),vec3.normalize(direction),vec3.set(that.transformation.translate,origin),!0):!1:!1},that},cameraComponent=function(spec){spec=spec||{},spec.name="camera";var that=core.nodeComponent(spec),_camera=spec.camera||camera(spec);return Object.defineProperties(that,{camera:{get:function(){return _camera}}}),that.update=function(){that.camera.transformation.set(that.node.world)},that},cameraNode=function(spec){spec=spec||{};var that=core.node(spec);return that.attachComponent(cameraComponent(spec)),that.get=function(){return that.getComponent("camera").camera},that},visibilitySet=function(spec){var that={},geometries=[],_camera=null;return Object.defineProperties(that,{camera:{get:function(){return _camera},set:function(value){_camera=value}}}),that.getGeometryCount=function(){return geometries.length},that.getGeometryAt=function(index){return geometries[index]},that.addGeometry=function(aGeometryNode){geometries.push(aGeometryNode)},that.reset=function(){geometries=[],that.camera=null},that},computeVisibilitySet=function(spec){spec=spec||{};var that=core.nodeVisitor(spec),result=visibilitySet();return result=spec.result?spec.result:result,result.reset(),result.camera=spec.camera||null,that.getResult=function(){return result},that.visitGroupNode=function(group){for(var i=0;i<group.getNodeCount();i++){var node=group.getNodeAt(i);node.accept(this)}},that.visitGeometryNode=function(geometry){result.addGeometry(geometry)},that},renderer=function(spec){var that={},gl=null,width=0,height=0,mMatrix=mat4.create(),vMatrix=mat4.create(),mvMatrix=mat4.create(),pMatrix=mat4.create(),clearColor=[.5,.5,.5,1],currentCamera=null,ubbershaderProgram=shaderProgram({vertexShader:shader({content:ubbershader_vs}),fragmentShader:shader({content:ubbershader_fs})}),defaultEffect=effect({shaderProgram:shaderProgram({vertexShader:shader({content:simple_vs}),fragmentShader:shader({content:simple_fs})})});return{configure:function(glContext,canvasWidth,canvasHeight){gl=glContext,width=canvasWidth,height=canvasHeight,this.setClearColor(clearColor),gl.enable(gl.DEPTH_TEST),gl.enable(gl.CULL_FACE),gl.frontFace(gl.CCW),gl.cullFace(gl.BACK),this.onCameraViewportChange(),this.onCameraFrustumChange(),this.onCameraFrameChange()},getClearColor:function(){return clearColor},setClearColor:function(color){this.clearColor=color,gl&&gl.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3])},setCurrentCamera:function(value){this.currentCamera=value,this.currentCamera&&this.currentCamera.target?(this.enableFramebuffer(this.currentCamera.target),gl.clearColor(this.currentCamera.target.clearColor[0],this.currentCamera.target.clearColor[1],this.currentCamera.target.clearColor[2],this.currentCamera.target.clearColor[3]),this.clearBuffers()):(this.disableFramebuffer(null),gl.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3])),this.onCameraViewportChange(),this.onCameraFrustumChange(),this.onCameraFrameChange()},getCurrentCamera:function(){return this.currentCamera},onCameraViewportChange:function(){if(this.currentCamera){var vp=this.currentCamera.viewport;this.currentCamera.target?gl.viewport(vp[0]*this.currentCamera.target.width,vp[1]*this.currentCamera.target.height,vp[2]*this.currentCamera.target.width,vp[3]*this.currentCamera.target.height):gl.viewport(vp[0]*width,vp[1]*height,vp[2]*width,vp[3]*height)}else gl.viewport(0,0,width,height)},onCameraFrustumChange:function(){this.currentCamera?this.currentCamera.computeProjectMatrix(pMatrix):mat4.perspective(45,width/height,.1,1e3,pMatrix)},onCameraFrameChange:function(){this.currentCamera?this.currentCamera.computeViewMatrix(vMatrix):mat4.identity(vMatrix)},clearBuffers:function(){gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)},clearBuffersInRect:function(x,y,width,height){gl.enable(gl.SCISSOR_TEST),gl.scissor(x,y,width,height),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.SCISSOR_TEST)},setMatrixUniforms:function(program){gl.uniformMatrix4fv(program.renderCache.pMatrixUniform,!1,pMatrix),program.renderCache.modelViewMatrixUniform?gl.uniformMatrix4fv(program.renderCache.modelViewMatrixUniform,!1,mvMatrix):(gl.uniformMatrix4fv(program.renderCache.modelMatrixUniform,!1,mMatrix),gl.uniformMatrix4fv(program.renderCache.viewMatrixUniform,!1,vMatrix));if(program.renderCache.nMatrixUniform){var normalMatrix=mat3.create();mat4.toInverseMat3(mvMatrix,normalMatrix),mat3.transpose(normalMatrix),gl.uniformMatrix3fv(program.renderCache.nMatrixUniform,!1,normalMatrix)}},setAlphaState:function(as){as.enabled?(gl.enable(gl.BLEND),gl.blendFunc(as.srcBlendFunc,as.dstBlendFunc)):gl.disable(gl.BLEND)},setDepthState:function(ds){ds.enabled?(gl.depthFunc(gl.LEQUAL),gl.enable(gl.DEPTH_TEST)):gl.disable(gl.DEPTH_TEST)},setCullState:function(ds){ds.enabled?(gl.enable(gl.CULL_FACE),gl.frontFace(gl.CCW),gl.cullFace(gl.BACK)):gl.disable(gl.CULL_FACE)},loadVertexBuffer:function(vbo){vbo.renderCache=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,vbo.renderCache),gl.bufferData(gl.ARRAY_BUFFER,vbo.getData(),gl.STATIC_DRAW),vbo.renderCache.renderer=this},unloadVertexBuffer:function(vbo){},enableVertexBuffer:function(vbo,program){(!vbo.isCacheEnabled()||!vbo.renderCache)&&this.loadVertexBuffer(vbo),gl.bindBuffer(gl.ARRAY_BUFFER,vbo.renderCache);var vf=vbo.getVertexFormat();gl.vertexAttribPointer(program.renderCache.vertexPositionAttribute,vf.positions,gl.FLOAT,!1,vf.getVertexSizeInBytes(),4*vf.getPositionsOffset()),program.renderCache.vertexNormalAttribute>=0&&(vf.normals>0?gl.vertexAttribPointer(program.renderCache.vertexNormalAttribute,vf.normals,gl.FLOAT,!1,vf.getVertexSizeInBytes(),4*vf.getNormalsOffset()):gl.vertexAttribPointer(program.renderCache.vertexNormalAttribute,vf.positions,gl.FLOAT,!1,vf.getVertexSizeInBytes(),4*vf.getPositionsOffset())),program.renderCache.vertexTextureCoordAttribute>=0&&(vf.textureCoords>0?gl.vertexAttribPointer(program.renderCache.vertexTextureCoordAttribute,vf.textureCoords,gl.FLOAT,!1,vf.getVertexSizeInBytes(),4*vf.getTextureCoordsOffset()):gl.vertexAttribPointer(program.renderCache.vertexTextureCoordAttribute,vf.positions,gl.FLOAT,!1,vf.getVertexSizeInBytes(),4*vf.getPositionsOffset())),program.renderCache.vertexTangentAttribute>=0&&(vf.tangents>0?gl.vertexAttribPointer(program.renderCache.vertexTangentAttribute,vf.tangents,gl.FLOAT,!1,vf.getVertexSizeInBytes(),4*vf.getTangentsOffset()):gl.vertexAttribPointer(program.renderCache.vertexTangentAttribute,vf.positions,gl.FLOAT,!1,vf.getVertexSizeInBytes(),4*vf.getPositionsOffset()))},disableVertexBuffer:function(){gl.bindBuffer(gl.ARRAY_BUFFER,null)},loadIndexBuffer:function(ibo){ibo.renderCache=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,ibo.renderCache),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,ibo.getData(),gl.STATIC_DRAW),ibo.renderCache.renderer=this},unloadIndexBuffer:function(ibo){},enableIndexBuffer:function(ibo){ibo.renderCache||this.loadIndexBuffer(ibo),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,ibo.renderCache)},disableIndexBuffer:function(){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)},enableLight:function(index,aLight,program){var lightUniform=program.renderCache.lightsUniform[index];lightUniform&&(gl.uniform3f(lightUniform.Position,aLight.position[0],aLight.position[1],aLight.position[2]),gl.uniform3f(lightUniform.Attenuation,aLight.attenuation[0],aLight.attenuation[1],aLight.attenuation[2]),gl.uniform3f(lightUniform.Direction,aLight.direction[0],aLight.direction[1],aLight.direction[2]),gl.uniform3f(lightUniform.Color,aLight.color[0],aLight.color[1],aLight.color[2]),gl.uniform3f(lightUniform.OuterCutoff,aLight.outerCutoff[0],aLight.outerCutoff[1],aLight.outerCutoff[2]),gl.uniform3f(lightUniform.InnerCutoff,aLight.innerCutoff[0],aLight.innerCutoff[1],aLight.innerCutoff[2]),gl.uniform3f(lightUniform.Exponent,aLight.exponent[0],aLight.exponent[1],aLight.exponent[2]))},disableLight:function(){},loadTexture:function(aTexture){aTexture.renderCache=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,aTexture.renderCache),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,aTexture.image.getContents()),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.bindTexture(gl.TEXTURE_2D,null)},unloadTexture:function(aTexture){},enableTexture:function(aTexture,index,program){aTexture.renderCache||this.loadTexture(aTexture);if(aTexture.renderCache){var uniformLocation=program.renderCache.customUniforms[aTexture.name];uniformLocation||(uniformLocation=gl.getUniformLocation(program.renderCache,aTexture.name),uniformLocation&&(program.renderCache.customUniforms[aTexture.name]=uniformLocation)),uniformLocation&&(gl.activeTexture(gl.TEXTURE0+index),gl.bindTexture(gl.TEXTURE_2D,aTexture.renderCache),this.setUniformInt(uniformLocation,index))}},disableTexture:function(aTexture,index){},enableFramebuffer:function(aFramebuffer){if(!aFramebuffer.renderCache){aFramebuffer.renderCache=gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,aFramebuffer.renderCache),aFramebuffer.texture.renderCache=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,aFramebuffer.texture.renderCache),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,aFramebuffer.width,aFramebuffer.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);var renderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,renderbuffer),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,aFramebuffer.width,aFramebuffer.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,aFramebuffer.texture.renderCache,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,renderbuffer),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null)}aFramebuffer.renderCache&&gl.bindFramebuffer(gl.FRAMEBUFFER,aFramebuffer.renderCache)},disableFramebuffer:function(aFramebuffer){gl.bindFramebuffer(gl.FRAMEBUFFER,null)},compileShader:function(shader,shaderType){shader.renderCache=gl.createShader(shaderType),gl.shaderSource(shader.renderCache,shader.getContent()),gl.compileShader(shader.renderCache),gl.getShaderParameter(shader.renderCache,gl.COMPILE_STATUS)||alert(gl.getShaderInfoLog(shader.renderCache)),shader.renderCache.renderer=this},getUniformByName:function(program,name){return gl.getUniformLocation(program.renderCache,name)},getAttribByName:function(program,name){return gl.getAttribLocation(program.renderCache,name)},setUniformInt:function(uniform,x,y,z,w){uniform&&(w!=null?gl.uniform4i(uniform,x,y,z,w):z!=null?gl.uniform3i(uniform,x,y,z):y!=null?gl.uniform2i(uniform,x,y):x!=null&&gl.uniform1i(uniform,x))},setUniformFloat:function(uniform,x,y,z,w){uniform&&(w!=null?gl.uniform4f(uniform,x,y,z,w):z!=null?gl.uniform3f(uniform,x,y,z):y!=null?gl.uniform2f(uniform,x,y):x!=null&&gl.uniform1f(uniform,x))},setCustomUniform:function(uniform,program){if(!uniform||!uniform.name)return;var uniformLocation=program.renderCache.customUniforms[uniform.name];uniformLocation||(uniformLocation=gl.getUniformLocation(program.renderCache,uniform.name),uniformLocation&&(program.renderCache.customUniforms[uniform.name]=uniformLocation)),uniformLocation&&(uniform.type===shaderUniform.type.BOOL?uniform.count===1&&this.setUniformInt(uniformLocation,uniform.data?1:0):uniform.type===shaderUniform.type.FLOAT&&(uniform.count===1?this.setUniformFloat(uniformLocation,uniform.data):uniform.count===2?this.setUniformFloat(uniformLocation,uniform.data[0],uniform.data[1]):uniform.count===3?this.setUniformFloat(uniformLocation,uniform.data[0],uniform.data[1],uniform.data[2]):uniform.count===3&&this.setUniformFloat(uniformLocation,uniform.data[0],uniform.data[1],uniform.data[2],uniform.data[3])))},loadProgram:function(program){this.compileShader(program.getVertexShader(),gl.VERTEX_SHADER),this.compileShader(program.getFragmentShader(),gl.FRAGMENT_SHADER),program.renderCache=gl.createProgram(),gl.attachShader(program.renderCache,program.getVertexShader().renderCache),gl.attachShader(program.renderCache,program.getFragmentShader().renderCache),gl.linkProgram(program.renderCache),gl.getProgramParameter(program.renderCache,gl.LINK_STATUS)||alert("Could not initialize shaders"),gl.useProgram(program.renderCache),program.renderCache.vertexPositionAttribute=gl.getAttribLocation(program.renderCache,"aVertexPosition"),gl.enableVertexAttribArray(program.renderCache.vertexPositionAttribute),program.renderCache.vertexNormalAttribute=gl.getAttribLocation(program.renderCache,"aVertexNormal"),program.renderCache.vertexNormalAttribute>=0&&gl.enableVertexAttribArray(program.renderCache.vertexNormalAttribute),program.renderCache.vertexTextureCoordAttribute=gl.getAttribLocation(program.renderCache,"aTextureCoord"),program.renderCache.vertexTextureCoordAttribute>=0&&gl.enableVertexAttribArray(program.renderCache.vertexTextureCoordAttribute),program.renderCache.vertexTangentAttribute=gl.getAttribLocation(program.renderCache,"aVertexTangent"),program.renderCache.vertexTangentAttribute>=0&&gl.enableVertexAttribArray(program.renderCache.vertexTangentAttribute),program.renderCache.pMatrixUniform=gl.getUniformLocation(program.renderCache,"uPMatrix"),program.renderCache.modelViewMatrixUniform=gl.getUniformLocation(program.renderCache,"uMVMatrix"),program.renderCache.modelMatrixUniform=gl.getUniformLocation(program.renderCache,"uMMatrix"),program.renderCache.viewMatrixUniform=gl.getUniformLocation(program.renderCache,"uVMatrix"),program.renderCache.nMatrixUniform=gl.getUniformLocation(program.renderCache,"uNMatrix"),program.renderCache.useLightingUniform=gl.getUniformLocation(program.renderCache,"uUseLighting"),program.renderCache.lightCountUniform=gl.getUniformLocation(program.renderCache,"uLightCount"),program.renderCache.lightsUniform=[];var lightPosId=0,lightIdx=0;do{lightPosId=gl.getUniformLocation(program.renderCache,"uLights["+lightIdx+"].Position");if(lightPosId!=null){var aLightUniform={};aLightUniform.Position=lightPosId,aLightUniform.Attenuation=gl.getUniformLocation(program.renderCache,"uLights["+lightIdx+"].Attenuation"),aLightUniform.Direction=gl.getUniformLocation(program.renderCache,"uLights["+lightIdx+"].Direction"),aLightUniform.Color=gl.getUniformLocation(program.renderCache,"uLights["+lightIdx+"].Color"),aLightUniform.OuterCutoff=gl.getUniformLocation(program.renderCache,"uLights["+lightIdx+"].OuterCutoff"),aLightUniform.InnerCutoff=gl.getUniformLocation(program.renderCache,"uLights["+lightIdx+"].InnerCutoff"),aLightUniform.Exponent=gl.getUniformLocation(program.renderCache,"uLights["+lightIdx+"].Exponent"),program.renderCache.lightsUniform.push(aLightUniform),lightIdx++}}while(lightPosId!=null);program.renderCache.materialUniform={},program.renderCache.materialUniform.ambient=gl.getUniformLocation(program.renderCache,"uMaterial.Ambient"),program.renderCache.materialUniform.diffuse=gl.getUniformLocation(program.renderCache,"uMaterial.Diffuse"),program.renderCache.materialUniform.specular=gl.getUniformLocation(program.renderCache,"uMaterial.Specular"),program.renderCache.materialUniform.shininess=gl.getUniformLocation(program.renderCache,"uMaterial.Shininess"),program.renderCache.useTexturesUniform=gl.getUniformLocation(program.renderCache,"uUseTextures"),program.renderCache.customUniforms={},program.renderCache.renderer=this},enableProgram:function(program){program.renderCache||this.loadProgram(program),gl.useProgram(program.renderCache)},disableProgram:function(program){gl.useProgram(null)},renderVisibilitySet:function(aVisibilitySet){aVisibilitySet.camera&&this.setCurrentCamera(aVisibilitySet.camera);for(var i=0;i<aVisibilitySet.getGeometryCount();i++)this.renderGeometryNode(aVisibilitySet.getGeometryAt(i))},renderGeometryNode:function(geometry){geometry.world.toMat4(mMatrix),mat4.multiply(vMatrix,mMatrix,mvMatrix);var grc=geometry.getComponent("geometryRender");if(grc)for(var p=0;p<geometry.getPrimitiveCount();p++){var primitive=geometry.getPrimitiveAt(p),vbo=primitive.getVertexBuffer(),ibo=primitive.getIndexBuffer();if(grc.getEffectCount()>0)for(var e=0;e<grc.getEffectCount();e++)this.applyEffect(grc,primitive,vbo,ibo,grc.getEffectAt(e));else this.applyDefaultEffect(grc,primitive,vbo,ibo)}},applyEffect:function(grc,primitive,vbo,ibo,currentEffect){var program=currentEffect.getProgram(),that=this;program||(program=ubbershaderProgram),this.enableProgram(program,grc),this.setMatrixUniforms(program),this.enableVertexBuffer(vbo,program),this.enableIndexBuffer(ibo,program),grc.eachUniform(function(uniform){that.setCustomUniform(uniform,program)}),this.setUniformInt(program.renderCache.useLightingUniform,grc.getLightCount()>0?1:0),this.setUniformInt(program.renderCache.lightCountUniform,grc.getLightCount());for(var l=0;l<grc.getLightCount();l++)this.enableLight(l,grc.getLightAt(l),program);this.setUniformInt(program.renderCache.useTexturesUniform,currentEffect.getTextureCount()>0?1:0);for(var t=0;t<currentEffect.getTextureCount();t++)this.enableTexture(currentEffect.getTextureAt(t),t,program);this.setUniformFloat(program.renderCache.materialUniform.ambient,currentEffect.ambient[0],currentEffect.ambient[1],currentEffect.ambient[2]),this.setUniformFloat(program.renderCache.materialUniform.diffuse,currentEffect.diffuse[0],currentEffect.diffuse[1],currentEffect.diffuse[2]),this.setUniformFloat(program.renderCache.materialUniform.specular,currentEffect.specular[0],currentEffect.specular[1],currentEffect.specular[2]),this.setUniformFloat(program.renderCache.materialUniform.shininess,currentEffect.shininess),gl.polygonOffset(4,8),gl.enable(gl.POLYGON_OFFSET_FILL),this.setDepthState(currentEffect.depthState),this.setAlphaState(currentEffect.alphaState),this.setCullState(currentEffect.cullState);var primitiveType=gl.TRIANGLES;primitive.getType()==core.primitive.types.POINTS?primitiveType=gl.POINTS:primitive.getType()==core.primitive.types.LINES&&(primitiveType=gl.LINES),gl.drawElements(primitiveType,ibo.getIndexCount(),gl.UNSIGNED_SHORT,0),this.disableIndexBuffer(ibo),this.disableVertexBuffer(vbo),this.disableProgram(program)},applyDefaultEffect:function(grc,primitive,vbo,ibo){this.applyEffect(grc,primitive,vbo,ibo,defaultEffect)}}};return{renderState:renderState,alphaState:alphaState,depthState:depthState,cullState:cullState,light:light,lightingComponent:lightingComponent,lightNode:lightNode,image:image,texture:texture,shader:shader,shaderProgram:shaderProgram,shaderUniform:shaderUniform,shaderUniformComponent:shaderUniformComponent,effect:effect,renderComponent:renderComponent,geometryRenderComponent:geometryRenderComponent,framebuffer:framebuffer,camera:camera,cameraComponent:cameraComponent,cameraNode:cameraNode,visibilitySet:visibilitySet,computeVisibilitySet:computeVisibilitySet,renderStateUpdate:renderStateUpdate,renderer:renderer}}),WebGLUtils=function(){var makeFailHTML=function(msg){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+msg+"</div>"+"</div>"+"</td></tr></table>"},GET_A_WEBGL_BROWSER='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',OTHER_PROBLEM='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',setupWebGL=function(canvas,opt_attribs,opt_onError){function handleCreationError(msg){var container=canvas.parentNode;if(container){var str=window.WebGLRenderingContext?OTHER_PROBLEM:GET_A_WEBGL_BROWSER;msg&&(str+="<br/><br/>Status: "+msg),container.innerHTML=makeFailHTML(str)}}opt_onError=opt_onError||handleCreationError,canvas.addEventListener&&canvas.addEventListener("webglcontextcreationerror",function(event){opt_onError(event.statusMessage)},!1);var context=create3DContext(canvas,opt_attribs);return context||window.WebGLRenderingContext||opt_onError(""),context},create3DContext=function(canvas,opt_attribs){var names=["webgl","experimental-webgl","webkit-3d","moz-webgl"],context=null;for(var ii=0;ii<names.length;++ii){try{context=canvas.getContext(names[ii],opt_attribs)}catch(e){}if(context)break}return context};return{create3DContext:create3DContext,setupWebGL:setupWebGL}}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1e3/60)}}(),define("../lib/webgl-utils",function(){}),define("crimild.simulation",["./crimild.core","./crimild.rendering","../lib/webgl-utils"],function(core,rendering,webgl){var simulator={},fetchCameras=function(spec){spec=spec||{};var that=core.nodeVisitor(spec),result=spec.result||[];return that.visitNode=function(aNode){var cc=aNode.getComponent("camera");cc&&cc.camera&&result.push(cc.camera)},that.visitGroupNode=function(aGroup){that.visitNode(aGroup);for(var i=0;i<aGroup.getNodeCount();i++)aGroup.getNodeAt(i).accept(that)},that.visitGeometryNode=function(aGeometry){that.visitNode(aGeometry)},that.getResults=function(){return results},that},task=function(spec){var that={},priority=0;return spec&&spec.priority&&(priority=spec.priority),that.getPriority=function(){return priority},that.setPriority=function(value){priority=value},that.onStart=function(){},that.onUpdate=function(){},that.onStop=function(){},that.onSuspend=function(){},that.onResume=function(){},that},taskManager=function(spec){var that={},activeTasks=[],suspendedTasks=[];return that.startTask=function(task){activeTasks.push(task)},that.stopTask=function(task){},that.suspendTask=function(task){},that.resumeTask=function(task){},that.updateAll=function(){for(var i in activeTasks){var task=activeTasks[i];task.onUpdate()}return!0},that},videoTask=function(spec){var that=task(spec);return that.onStart=function(){console.log("start video")},that},updateSceneTask=function(spec){var that=task(spec),_startTime=(new Date).getTime(),_lastTime=_startTime;return that.onUpdate=function(){var appTime=(new Date).getTime()-_startTime,deltaTime=appTime-_lastTime;deltaTime<0&&(deltaTime=0),_lastTime=appTime;for(var i=0;i<simulator.getSceneCount();i++){var scene=simulator.getSceneAt(i);scene.root&&scene.root.perform(core.updateScene({appTime:appTime,deltaTime:deltaTime}))}},that},renderSceneTask=function(spec){var that=task(spec);return that.onUpdate=function(){simulator.getRenderer().clearBuffers();var visibilitySet=rendering.visibilitySet();for(var i=0;i<simulator.getSceneCount();i++){var scene=simulator.getSceneAt(i);if(scene.cameras.length>0)for(var c in scene.cameras)scene.root.perform(rendering.computeVisibilitySet({result:visibilitySet,camera:scene.cameras[c]})),simulator.getRenderer().renderVisibilitySet(visibilitySet);else scene.root.perform(rendering.computeVisibilitySet({result:visibilitySet})),simulator.getRenderer().renderVisibilitySet(visibilitySet)}},that},input=function(spec){spec=spec||{};var that={},_grabInput=spec.grabInput||!1,_mouseButtonDown=!1,_mousePos=vec2.create(),_mouseDelta=vec2.create();Object.defineProperties(that,{grabInput:{get:function(){return _grabInput},set:function(value){_grabInput=value}}});var currentState={};return that.update=function(){_mouseDelta[0]=0,_mouseDelta[1]=0},document.onkeydown=function(ev){_grabInput&&ev.preventDefault(),currentState[ev.keyCode]=!0},document.onkeyup=function(ev){_grabInput&&ev.preventDefault(),currentState[ev.keyCode]=!1},spec.canvas.onmousedown=function(ev){_mouseButtonDown=!0},document.onmouseup=function(ev){_mouseButtonDown=!1},document.onmousemove=function(ev){_mouseDelta[0]=ev.clientX-_mousePos[0],_mouseDelta[1]=ev.clientY-_mousePos[1],_mousePos[0]=ev.clientX,_mousePos[1]=ev.clientY},that.isKeyDown=function(code){return currentState[code]==1},that.isKeyUp=function(code){return currentState[code]==0},that.isMouseButtonDown=function(){return _mouseButtonDown==1},that.isMouseButtonUp=function(){return _mouseButtonDown==0},that.getMousePos=function(dest){return dest||(dest=vec2.create),vec2.set(_mousePos,dest),dest},that.getMouseDelta=function(dest){return dest||(dest=vec2.create),vec2.set(_mouseDelta,dest),dest},that},run=function(spec){spec=spec||{};var renderer=rendering.renderer(),tasks=taskManager(),scenes=[];simulator.addScene=function(root){if(!root)return;root.perform(core.worldStateUpdate()),root.perform(rendering.renderStateUpdate());var cameras=[];root.perform(fetchCameras({result:cameras})),scenes.push({root:root,cameras:cameras})},simulator.getSceneCount=function(){return scenes.length},simulator.getSceneAt=function(index){return scenes[index]},simulator.getTasks=function(){return tasks},simulator.getRenderer=function(){return renderer},simulator.tick=function(){requestAnimFrame(simulator.tick),simulator.getTasks().updateAll()},simulator.getTasks().startTask(videoTask({priority:0})),simulator.getTasks().startTask(updateSceneTask({priority:100})),simulator.getTasks().startTask(renderSceneTask({priority:200}));var canvas=spec.canvas;if(!canvas)return alert("No canvas provided"),null;try{gl=canvas.getContext("experimental-webgl")}catch(e){console.log("Error initializing GL Context:",e)}if(!gl){var answer=confirm("Cannot initialize WebGL context. Please make sure your browser supports WebGL and verify that you have the latest drivers for you graphics card.\n\nMore information: http://get.webgl.org");return answer&&(window.location="http://get.webgl.org"),null}renderer.configure(gl,canvas.width,canvas.height);if(spec.scenes)for(var i in spec.scenes)simulator.addScene(spec.scenes[i]);return simulator.input=input(spec),simulator.tick(),simulator};return{run:run,simulator:simulator}}),define("crimild.components",["crimild.core","crimild.math","crimild.simulation"],function(core,math,simulation){var rotationComponent=function(spec){spec=spec||{};var that=core.nodeComponent({name:spec.name||"update"}),angle=0,angleInc=spec.angle||.01,axis=vec3.normalize(spec.axis)||[0,1,0];return that.update=function(){that.node.local.rotate=quat4.fromAngleAxis(angle,axis),that.node.perform(core.worldStateUpdate()),angle+=angleInc},that},orbitingComponent=function(spec){spec=spec||{};var that=core.nodeComponent({name:spec.name||"update"}),x0=spec.x0||0,y0=spec.y0||0,x=0,y=0,a=spec.a||20,b=spec.b||20,t=0,speed=spec.speed||.01,gamma=spec.gamma||0;return that.update=function(){x=x0+a*Math.cos(t)*Math.cos(gamma)-b*Math.sin(t)*Math.sin(gamma),y=y0+a*Math.cos(t)*Math.sin(gamma)+b*Math.sin(t)*Math.cos(gamma),t+=speed,that.node.local.translate=[x,y,that.node.local.translate[2]],that.node.perform(core.worldStateUpdate())},that},trackballComponent=function(){var that=crimild.core.nodeComponent({name:"update"}),mousePos=vec2.create(),mouseDelta=vec2.create(),mouseDown=!1,qPitch=quat4.create(),qYaw=quat4.create(),qTemp=quat4.create(),vUp=vec3.create();return that.update=function(){crimild.simulation.simulator.input.getMousePos(mousePos),crimild.simulation.simulator.input.getMouseDelta(mouseDelta),crimild.simulation.simulator.input.isMouseButtonDown()&&(that.node.local.computeWorldUp(vUp),quat4.fromAngleAxis(mouseDelta[1]/10*Math.PI/180,[1,0,0],qPitch),quat4.fromAngleAxis(mouseDelta[0]/10*Math.PI/180,[0,1,0],qYaw),quat4.multiply(qPitch,qYaw,qTemp),quat4.multiply(qTemp,that.node.local.rotate,qTemp),that.node.local.rotate=qTemp),that.node.perform(crimild.core.worldStateUpdate())},that},simpleCameraComponent=function(){var that=crimild.core.nodeComponent({name:"update"}),angle=0,tempVec3=vec3.create(),tempDirection=vec3.create(),speed=.025,z=0,qPitch=quat4.create(),qYaw=quat4.create(),qRot=quat4.create(),qTemp=quat4.create(),vRight=[1,0,0],vUp=[0,1,0];return that.update=function(){simulation.simulator.input.isKeyDown(38)?z=speed:simulation.simulator.input.isKeyDown(40)?z=-speed:z=0,that.node.local.computeWorldUp(vUp),simulation.simulator.input.isKeyDown(37)?quat4.fromAngleAxis(.05,vUp,qYaw):simulation.simulator.input.isKeyDown(39)?quat4.fromAngleAxis(-0.05,vUp,qYaw):quat4.identity(qYaw),simulation.simulator.input.isKeyDown("A".charCodeAt(0))?quat4.fromAngleAxis(.05,vRight,qPitch):simulation.simulator.input.isKeyDown("Z".charCodeAt(0))?quat4.fromAngleAxis(-0.05,vRight,qPitch):quat4.identity(qPitch),quat4.multiply(qPitch,qYaw,qRot),quat4.multiply(that.node.local.rotate,qRot,qTemp),that.node.local.rotate=qTemp,that.node.local.computeDirection(tempDirection),that.node.local.translate[0]+=z*tempDirection[0],that.node.local.translate[2]+=z*tempDirection[2],that.node.perform(crimild.core.worldStateUpdate())},that},lerpTransformComponent=function(spec){var that=core.nodeComponent(spec),_start=math.transformation(),_end=math.transformation(),_speed=spec.speed||.01,_t=0;return Object.defineProperties(that,{start:{get:function(){return _start},set:function(value){_start.set(value)}},end:{get:function(){return _end},set:function(value){_end.set(value)}}}),that.onAttach=function(){that.start.set(spec.start),that.end.set(spec.end),that.node.local.set(that.start),that.node.perform(core.worldStateUpdate())},that.update=function(){_t>1?(that.node.local.set(that.end),that.node.perform(core.worldStateUpdate()),spec.callback?spec.callback(that):that.node.detachComponent(that)):(vec3.lerp(that.start.translate,that.end.translate,Math.min(1,_t),that.node.local.translate),quat4.slerp(that.start.rotate,that.end.rotate,Math.min(1,_t),that.node.local.rotate),that.node.perform(core.worldStateUpdate()),_t+=_speed)},that};return{rotationComponent:rotationComponent,orbitingComponent:orbitingComponent,trackballComponent:trackballComponent,lerpTransformComponent:lerpTransformComponent}}),define("crimild.obj",["crimild.core","crimild.rendering"],function(core,rendering){String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")};var parseMaterials=function(mtlfile){var materials={},lines=mtlfile.split("\n"),currentMaterial={};for(var l in lines){var vals=lines[l].trim().replace(/^\s+/,"").split(/\s+/);vals[0]==="newmtl"?(currentMaterial={name:vals[1]},materials[currentMaterial.name]=currentMaterial):vals[0]==="Ka"?currentMaterial.ambient=[parseFloat(vals[1]),parseFloat(vals[2]),parseFloat(vals[3])]:vals[0]==="Kd"?currentMaterial.diffuse=[parseFloat(vals[1]),parseFloat(vals[2]),parseFloat(vals[3])]:vals[0]==="Ks"?currentMaterial.specular=[parseFloat(vals[1]),parseFloat(vals[2]),parseFloat(vals[3])]:vals[0]==="map_Kd"?currentMaterial.diffuseMapName=vals[1]:vals[0]==="map_kS"&&(currentMaterial.specularMapName=vals[1])}return materials},objNode=function(spec){spec=spec||{};var that=core.groupNode(spec),materials={};spec.mtlfile&&(materials=parseMaterials(spec.mtlfile));if(spec.file){var lines=spec.file.split("\n"),positions=[],normals=[],textureCoords=[],hasNormals=!1,hasTextureCoords=!1,groups=[],currentGroup={name:"unknown",faces:[]};groups.push(currentGroup);for(var l in lines){var vals=lines[l].trim().replace(/^\s+/,"").split(/\s+/);if(vals.length>0&&vals[0]!="#")if(vals[0]==="v")positions.push(parseFloat(vals[1])),positions.push(parseFloat(vals[2])),positions.push(parseFloat(vals[3]));else if(vals[0]==="vn")hasNormals=!0,normals.push(parseFloat(vals[1])),normals.push(parseFloat(vals[2])),normals.push(parseFloat(vals[3]));else if(vals[0]==="vt")hasTextureCoords=!0,textureCoords.push(parseFloat(vals[1])),textureCoords.push(parseFloat(vals[2]));else if(vals[0]==="f"){var faceCount=vals.length-1;faceCount===3?(currentGroup.faces.push(vals[1]),currentGroup.faces.push(vals[2]),currentGroup.faces.push(vals[3])):faceCount===4&&(currentGroup.faces.push(vals[1]),currentGroup.faces.push(vals[2]),currentGroup.faces.push(vals[3]),currentGroup.faces.push(vals[1]),currentGroup.faces.push(vals[3]),currentGroup.faces.push(vals[4]))}else vals[0]!=="g"&&vals[0]!=="o"&&vals[0]!=="mtllib"&&vals[0]==="usemtl"&&(currentGroup={name:vals[1],materialName:vals[1],faces:[]},groups.push(currentGroup))}var vertexFormat=core.vertexFormat({positions:3,normals:hasNormals?3:0,textureCoords:hasTextureCoords?2:0});for(var g in groups){var group=groups[g],indices=[],vertices=[];for(var i=0;i<group.faces.length;i++){var face=group.faces[i].split("/"),pIdx=parseInt(face[0])-1;vertices.push(positions[pIdx*3+0]),vertices.push(positions[pIdx*3+1]),vertices.push(positions[pIdx*3+2]);if(hasNormals){var nIdx=parseInt(face[2])-1;vertices.push(normals[nIdx*3+0]),vertices.push(normals[nIdx*3+1]),vertices.push(normals[nIdx*3+2])}if(hasTextureCoords){var tIdx=parseInt(face[1])-1;vertices.push(textureCoords[tIdx*2+0]),vertices.push(textureCoords[tIdx*2+1])}indices.push(i)}var vertexCount=vertices.length/vertexFormat.getVertexSize();that.attachNode(core.geometryNode({name:group.name||"unknown",primitives:[core.primitive({vertexBuffer:core.vertexBufferObject({vertexFormat:vertexFormat,vertexCount:vertexCount,data:new Float32Array(vertices)}),indexBuffer:core.indexBufferObject({indexCount:indices.length,data:new Uint16Array(indices)})})],components:[function(){if(group.materialName){var material=materials[group.materialName];if(material)return rendering.renderComponent({effects:[rendering.effect({shaderProgram:spec.shaderProgram,diffuse:material.diffuse,ambient:material.ambient,specular:material.specular,textures:function(){var textures=[],img;return spec.images&&(material.diffuseMapName&&(img=spec.images[material.diffuseMapName],img&&textures.push(rendering.texture({image:img}))),material.specularMapName&&(img=spec.images[material.specularMapName],img&&textures.push(rendering.texture({name:"uSpecularMapSampler",image:img})))),textures}()})]})}return null}()]}))}}return that};return{objNode:objNode}}),define("crimild.utils",["crimild.core","crimild.rendering"],function(core,rendering){var printScene=function(spec){var that=core.nodeVisitor(spec),identCout=0;that.visitNode=function(node){print("(node) "+node.getName())},that.visitGroupNode=function(groupNode){print("(groupNode) "+groupNode.getName()),identCout++;for(var i=0;i<groupNode.getNodeCount();i++)groupNode.getNodeAt(i).accept(this);identCout--},that.visitGeometryNode=function(geometryNode){print("(geometryNode) "+geometryNode.getName())};var print=function(str){var spaces="";for(var i=0;i<identCout;i++)spaces+="   ";console.log(spaces+str)};return that},assetManager=function(spec){spec=spec||{};var that={},successCount=0,errorCount=0,imageQueue=[],imageCache={},fileQueue=[],fileCache={};return that.queueImage=function(imageUrl){imageQueue.push(imageUrl)},that.queueFile=function(fileUrl){fileQueue.push(fileUrl)},that.loadAllImages=function(callback){for(var i=0;i<imageQueue.length;i++){var url=imageQueue[i],image=new Image;image.addEventListener("load",function(){successCount+=1,that.isDone()&&callback()},!1),image.addEventListener("error",function(){errorCount+=1,that.isDone()&&callback()},!1),image.src=url,imageCache[url]=rendering.image({contents:image})}},that.loadAllFiles=function(callback){for(var i=0;i<fileQueue.length;i++){var url=fileQueue[i],request=new XMLHttpRequest;request.open("GET",url,!1),request.onload=function(){request.status===200?(successCount+=1,fileCache[url]=request.responseText):errorCount+=1,that.isDone()&&callback()},request.onerror=function(){errorCount+=1,that.isDone()&&callback()},request.send(null)}},that.isDone=function(){return imageQueue.length+fileQueue.length===successCount+errorCount},that.loadAll=function(callback){imageQueue.length===0&&fileQueue===0?callback():(that.loadAllImages(callback),that.loadAllFiles(callback))},that.getImage=function(url){return imageCache[url]},that.getFile=function(url){return fileCache[url]},that},getTextFromElement=function(elementId){var script=document.getElementById(elementId),str="",k=script.firstChild;while(k)k.nodeType==3&&(str+=k.textContent),k=k.nextSibling;return str};return{getTextFromElement:getTextFromElement,assetManager:assetManager,printScene:printScene}}),define("text!../shaders/particle_system.vert",[],function(){return"attribute vec3 aVertexPosition;\nattribute vec3 aVertexNormal;   // used for initial velocity\nattribute vec3 aTextureCoord;   // tc0 = lifeTime, tc1 = unused\n\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform float uTime;\nuniform float uLifetime;\nuniform vec3 uGravity;\n\nvarying float vTime;\n\nvoid main(void) {\n    float size = aTextureCoord[0];\n    float offset = aTextureCoord[1];\n    vTime = uTime + offset;\n    vTime = vTime - uLifetime * floor(vTime / uLifetime);\n    vec3 position = aVertexPosition + aVertexNormal * vTime + 0.5 * vTime * vTime * uGravity;\n\n    gl_Position = uPMatrix * uMVMatrix * vec4(position, 1.0);\n    gl_PointSize = (uLifetime - vTime) * size;\n}\n"}),define("text!../shaders/particle_system.frag",[],function(){return"precision highp float;\n\nuniform sampler2D uSampler;\nuniform float uLifetime;\n\nvarying float vTime;\n\nvoid main(void) {\n    vec4 texColor = texture2D(uSampler, gl_PointCoord);\n    if (texColor.r * texColor.g * texColor.b < 0.01) {\n    	discard;\n    }\n    else {\n    	gl_FragColor = vec4(0.75, 0.75, 0.75, 1.0) * texColor;\n    	gl_FragColor.a = 0.5 * (uLifetime - vTime) / uLifetime;\n    }\n}\n"}),define("crimild.particles",["crimild.core","crimild.rendering","text!../shaders/particle_system.vert","text!../shaders/particle_system.frag"],function(core,rendering,default_vs,default_fs){var particleSystem=function(spec){spec=spec||{};var vertices=[],indices=[],particleCount=spec.particleCount||10,_duration=spec.duration||1,_loop=spec.loop||!1,_gravity=spec.gravity||vec3.create([0,0,0]),_velocity=spec.velocity||vec3.create([1,1,1]),_spread=spec.spread||vec3.create([1,1,1]),_particleSize=spec.particleSize||20,that=core.geometryNode(spec);Object.defineProperties(that,{duration:{get:function(){return _duration},set:function(value){_duration=value}},loop:{get:function(){return _loop},set:function(value){_loop=value}},gravity:{get:function(){return _gravity},set:function(value){_gravity=value}}});for(var i=0;i<particleCount;i++)vertices.push(Math.random()-.5),vertices.push(Math.random()-.5),vertices.push(Math.random()-.5),vertices.push(_velocity[0]+_spread[0]*(2*Math.random()-1)),vertices.push(_velocity[1]+_spread[1]*(2*Math.random()-1)),vertices.push(_velocity[2]+_spread[2]*(2*Math.random()-1)),vertices.push(Math.max(_particleSize*.25,_particleSize*Math.random())),vertices.push(that.duration*Math.random()),indices.push(i);return that.attachPrimitive(core.primitive({type:core.primitive.types.POINTS,vertexBuffer:core.vertexBufferObject({vertexFormat:core.vertexFormat({positions:3,normals:3,textureCoords:2}),vertexCount:particleCount,data:new Float32Array(vertices)}),indexBuffer:core.indexBufferObject({indexCount:particleCount,data:new Uint16Array(indices)})})),that.attachComponent(rendering.renderComponent({effects:[rendering.effect({shaderProgram:rendering.shaderProgram({vertexShader:rendering.shader({content:default_vs}),fragmentShader:rendering.shader({content:default_fs})}),textures:spec.texture?[spec.texture]:[],alphaState:rendering.alphaState({enabled:!0})})]})),that.attachComponent(function(){var time=0,cmp=rendering.shaderUniformComponent({uniforms:[rendering.shaderUniform({name:"uTime",data:time,type:rendering.shaderUniform.type.FLOAT}),rendering.shaderUniform({name:"uGravity",data:that.gravity,type:rendering.shaderUniform.type.FLOAT,count:3}),rendering.shaderUniform({name:"uLifetime",data:that.duration,type:rendering.shaderUniform.type.FLOAT})]});return cmp.update=function(appTime,deltaTime){time+=deltaTime/1e3,cmp.getUniform("uTime").data=time},cmp}()),that};return{particleSystem:particleSystem}}),define("crimild",["./crimild.math","./crimild.core","./crimild.core.primitives","./crimild.components","./crimild.rendering","./crimild.simulation","./crimild.obj","./crimild.utils","./crimild.particles"],function(math,core,primitives,components,rendering,simulation,obj,utils,particles){return{math:math,core:core,primitives:primitives,components:components,rendering:rendering,simulation:simulation,obj:obj,utils:utils,particles:particles}})